<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RCEM QIP Assistant (QIAT v7)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        slate: { 850: '#1e293b', 900: '#0f172a' },
                        rcem: { 
                            purple: '#2d2e83', 
                            orange: '#f36f21',
                            light: '#f4f6f8',
                            green: '#10b981'
                        } 
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        serif: ['Merriweather', 'serif'],
                    },
                    animation: {
                        'pulse-fast': 'pulse 1s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    }
                }
            }
        }
    </script>
    
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Merriweather:wght@300;400;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; }
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .glass {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }
        .dark .glass {
            background: rgba(30, 41, 59, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        /* Guide Sidebar Transition */
        #guide-panel { transition: width 0.3s ease-in-out; }
        
        #toast-container { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 100; }
        
        .dark body { background-color: #0f172a; color: #e2e8f0; }
        .dark input, .dark textarea, .dark select { background-color: rgba(30, 41, 59, 0.5); border-color: #475569; color: white; }
    </style>
</head>
<body class="bg-slate-100 text-slate-900 h-screen overflow-hidden flex flex-col bg-[url('https://www.transparenttextures.com/patterns/cubes.png')]">

    <div id="ig-banner" class="bg-amber-100 dark:bg-amber-900 border-b border-amber-200 dark:border-amber-800 text-amber-900 dark:text-amber-100 px-4 py-2 text-xs md:text-sm font-medium flex justify-between items-center z-50">
        <div class="flex items-center gap-2">
            <i data-lucide="shield-alert" class="w-4 h-4 text-amber-600 dark:text-amber-400"></i>
            <span>INFORMATION GOVERNANCE: Do <strong>NOT</strong> enter patient names, DoBs, or NHS Numbers.</span>
        </div>
        <button onclick="document.getElementById('ig-banner').remove()" class="text-amber-700 hover:text-amber-900"><i data-lucide="x" class="w-4 h-4"></i></button>
    </div>

    <div class="flex flex-1 overflow-hidden relative">
        
        <div id="auth-screen" class="fixed inset-0 bg-slate-900/90 backdrop-blur-sm z-50 flex items-center justify-center p-4">
            <div class="glass bg-white rounded-xl shadow-2xl w-full max-w-md overflow-hidden fade-in">
                <div class="bg-white/50 p-8 text-center border-b border-slate-100/50">
                    <img src="https://iili.io/KGQOvkl.md.png" alt="WMEBEM Logo" class="h-16 mx-auto mb-4 object-contain">
                    <h1 class="text-2xl font-bold text-slate-900">RCEM QIP Assistant</h1>
                    <p class="text-slate-500 mt-1 text-sm">Updated for QIAT v7 (2025)</p>
                </div>
                <div class="p-8">
                    <form id="auth-form" class="space-y-4">
                        <input type="email" id="email" required class="w-full p-3 rounded-lg border border-slate-300 outline-none focus:ring-2 focus:ring-rcem-purple" placeholder="doctor@nhs.net">
                        <input type="password" id="password" class="w-full p-3 rounded-lg border border-slate-300 outline-none focus:ring-2 focus:ring-rcem-purple" placeholder="••••••••">
                        <button type="submit" id="auth-btn" class="w-full bg-rcem-purple hover:bg-indigo-900 text-white font-bold py-3 rounded-lg transition-all shadow-lg">Sign In</button>
                    </form>
                    <button onclick="loadDemoMode()" class="w-full mt-3 bg-white border border-slate-300 text-slate-600 font-bold py-3 rounded-lg hover:bg-slate-50 flex justify-center items-center gap-2">
                        <i data-lucide="sparkles" class="w-4 h-4 text-amber-500"></i> See Example Project
                    </button>
                    <div class="mt-4 text-center text-sm">
                        <button id="toggle-auth" class="text-rcem-purple hover:underline">Create Account</button>
                    </div>
                </div>
            </div>
        </div>

        <aside id="app-sidebar" class="hidden w-64 bg-slate-900/95 backdrop-blur-xl text-white flex-col h-full border-r border-white/10 flex-shrink-0">
            <div class="p-6 border-b border-white/10 text-center">
                <img src="https://iili.io/KGQOvkl.md.png" class="h-12 mx-auto mb-2 bg-white rounded p-1">
                <h1 class="font-bold tracking-tight">QIP Assistant</h1>
            </div>
            <nav class="flex-1 p-4 space-y-1 overflow-y-auto">
                <button onclick="router('dashboard')" class="nav-btn w-full flex items-center gap-3 px-4 py-3 rounded-lg text-slate-300 hover:bg-white/10" id="nav-dashboard"><i data-lucide="layout-dashboard" class="w-5 h-5"></i> Dashboard</button>
                <button onclick="router('qiat')" class="nav-btn w-full flex items-center gap-3 px-4 py-3 rounded-lg text-slate-300 hover:bg-white/10" id="nav-qiat"><i data-lucide="clipboard-check" class="w-5 h-5"></i> QIAT Form (v7)</button>
                <button onclick="router('data')" class="nav-btn w-full flex items-center gap-3 px-4 py-3 rounded-lg text-slate-300 hover:bg-white/10" id="nav-data"><i data-lucide="bar-chart-2" class="w-5 h-5"></i> Data & SPC</button>
                <button onclick="router('tools')" class="nav-btn w-full flex items-center gap-3 px-4 py-3 rounded-lg text-slate-300 hover:bg-white/10" id="nav-tools"><i data-lucide="tool" class="w-5 h-5"></i> Strategy Tools</button>
                <button onclick="router('pdsa')" class="nav-btn w-full flex items-center gap-3 px-4 py-3 rounded-lg text-slate-300 hover:bg-white/10" id="nav-pdsa"><i data-lucide="refresh-cw" class="w-5 h-5"></i> PDSA Cycles</button>
                <button onclick="router('green')" class="nav-btn w-full flex items-center gap-3 px-4 py-3 rounded-lg text-slate-300 hover:bg-white/10" id="nav-green"><i data-lucide="leaf" class="w-5 h-5"></i> Green ED</button>
            </nav>
            <div class="p-4 border-t border-white/10">
                <button onclick="toggleGuide()" class="w-full flex items-center justify-center gap-2 bg-amber-500 text-white px-4 py-2 rounded-lg font-bold shadow hover:bg-amber-600 mb-4"><i data-lucide="compass" class="w-4 h-4"></i> Toggle Guide</button>
                <button onclick="signOutApp()" class="w-full text-slate-400 hover:text-white text-sm flex items-center gap-2"><i data-lucide="log-out" class="w-4 h-4"></i> Sign Out</button>
            </div>
        </aside>

        <main class="flex-1 flex overflow-hidden relative bg-slate-100 dark:bg-slate-900">
            
            <div id="main-scroll" class="flex-1 overflow-y-auto p-4 md:p-8 relative">
                
                <div class="glass sticky top-0 z-20 px-6 py-3 flex justify-between items-center shadow-sm rounded-xl mb-6">
                    <div class="flex items-center text-sm">
                        <span id="save-status" class="flex items-center gap-1 text-emerald-600 font-medium"><i data-lucide="check-circle" class="w-4 h-4"></i> Saved</span>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="loadDemoMode()" class="text-xs bg-indigo-50 text-indigo-700 px-3 py-1.5 rounded border border-indigo-200 hover:bg-indigo-100">View Demo</button>
                        <button onclick="toggleDarkMode()" class="text-slate-500 hover:text-slate-800"><i data-lucide="moon" class="w-4 h-4"></i></button>
                    </div>
                </div>

                <div id="toast-container"></div>

                <div id="view-dashboard" class="view-section space-y-6 fade-in">
                    <header class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                        <div>
                            <h2 class="text-3xl font-bold text-slate-800 dark:text-white">Dashboard</h2>
                            <p class="text-slate-500 dark:text-slate-400">Project Overview</p>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="generateReport()" class="bg-rcem-purple text-white px-4 py-2 rounded-lg shadow hover:bg-indigo-900 flex gap-2 items-center"><i data-lucide="file-text" class="w-4 h-4"></i> SQUIRE Report</button>
                            <button onclick="router('poster')" class="bg-white text-slate-700 border px-4 py-2 rounded-lg shadow-sm hover:bg-slate-50 flex gap-2 items-center"><i data-lucide="layout" class="w-4 h-4"></i> Poster</button>
                        </div>
                    </header>

                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div class="glass p-4 rounded-xl border-l-4 border-rcem-purple">
                            <span class="text-xs text-slate-500 uppercase font-bold">QIAT Status</span>
                            <div class="text-2xl font-bold dark:text-white" id="stat-qiat">0%</div>
                        </div>
                        <div class="glass p-4 rounded-xl border-l-4 border-amber-500">
                            <span class="text-xs text-slate-500 uppercase font-bold">Data Points</span>
                            <div class="text-2xl font-bold dark:text-white" id="stat-data">0</div>
                        </div>
                        <div class="glass p-4 rounded-xl border-l-4 border-emerald-500">
                            <span class="text-xs text-slate-500 uppercase font-bold">PDSA Cycles</span>
                            <div class="text-2xl font-bold dark:text-white" id="stat-pdsa">0</div>
                        </div>
                         <div class="glass p-4 rounded-xl border-l-4 border-blue-500">
                            <span class="text-xs text-slate-500 uppercase font-bold">Improvement</span>
                            <div class="text-xl font-bold dark:text-white" id="stat-imp">None Yet</div>
                        </div>
                    </div>

                    <div id="setup-card" class="glass rounded-xl p-8 text-center border-dashed border-2 border-slate-300 hidden">
                        <div class="w-16 h-16 bg-indigo-100 text-indigo-600 rounded-full flex items-center justify-center mx-auto mb-4"><i data-lucide="rocket" class="w-8 h-8"></i></div>
                        <h3 class="text-xl font-bold text-slate-800 dark:text-white">Start Your Project</h3>
                        <p class="text-slate-500 mb-6 max-w-md mx-auto">Use the RCEM templates to get started quickly.</p>
                        <button onclick="openWizard()" class="bg-rcem-purple text-white px-6 py-2 rounded-lg shadow hover:bg-indigo-900">Launch Wizard</button>
                    </div>

                    <div id="aim-display" class="glass rounded-xl p-6 relative group">
                        <h3 class="font-bold text-slate-800 dark:text-white mb-2">Current Aim</h3>
                        <p id="dash-aim-text" class="text-indigo-800 dark:text-indigo-300 italic font-serif text-lg">No aim defined.</p>
                        <button onclick="router('qiat')" class="absolute top-4 right-4 text-xs bg-slate-100 px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity">Edit</button>
                    </div>
                </div>

                <div id="view-qiat" class="view-section hidden fade-in max-w-5xl mx-auto">
                    <header class="mb-6 border-b pb-4">
                        <h2 class="text-3xl font-bold text-slate-800 dark:text-white">QIAT Assessment (v7)</h2>
                        <p class="text-slate-500 dark:text-slate-400">Aligned with RCEM ePortfolio 2025.</p>
                    </header>
                    
                    <div class="space-y-6">
                        <div class="glass p-6 rounded-xl">
                            <h3 class="text-lg font-bold text-rcem-purple mb-4">Project Overview</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div><label class="label">Project Title</label><input class="input-field" id="qiat-title" onchange="saveQiat('title', this.value)"></div>
                                <div><label class="label">Lead Trainee</label><input class="input-field" id="qiat-lead" onchange="saveQiat('lead', this.value)"></div>
                                <div><label class="label">Supervisors</label><input class="input-field" id="qiat-supervisors" onchange="saveQiat('supervisors', this.value)"></div>
                                <div><label class="label">Date Started</label><input type="date" class="input-field" id="qiat-date" onchange="saveQiat('date', this.value)"></div>
                            </div>
                        </div>

                        <div class="glass p-6 rounded-xl border-l-4 border-indigo-500">
                            <h3 class="text-lg font-bold text-rcem-purple mb-1">Domain 1: Plan</h3>
                            <p class="text-xs text-slate-500 mb-4">Problem definition, Aim, and Strategy.</p>
                            
                            <div class="space-y-4">
                                <div>
                                    <label class="label">What is the problem? (Background & Rationale)</label>
                                    <textarea class="input-area" rows="3" id="qiat-problem" onchange="saveQiat('problem', this.value)" placeholder="Describe the local problem and evidence..."></textarea>
                                </div>
                                <div>
                                    <label class="label flex justify-between"><span>SMART Aim</span> <span class="text-xs font-normal text-amber-600 bg-amber-100 px-2 rounded">Tip: Increase X from Y% to Z% by [Date]</span></label>
                                    <input class="input-field" id="qiat-aim" onchange="saveQiat('aim', this.value)" placeholder="Specific, Measurable, Achievable, Realistic, Time-bound">
                                </div>
                                <div>
                                    <label class="label">Drivers & Change Ideas (Strategy)</label>
                                    <textarea class="input-area" rows="3" id="qiat-strategy" onchange="saveQiat('strategy', this.value)" placeholder="Summarize your primary drivers and change ideas here..."></textarea>
                                </div>
                            </div>
                        </div>

                        <div class="glass p-6 rounded-xl border-l-4 border-blue-500">
                            <h3 class="text-lg font-bold text-rcem-purple mb-1">Domain 2: Do</h3>
                            <p class="text-xs text-slate-500 mb-4">Implementation and Teamwork.</p>
                            <div class="space-y-4">
                                <div>
                                    <label class="label">Interventions & Timeline</label>
                                    <textarea class="input-area" rows="3" id="qiat-interventions" onchange="saveQiat('interventions', this.value)" placeholder="What did you do and when?"></textarea>
                                </div>
                                <div>
                                    <label class="label">Team Engagement</label>
                                    <textarea class="input-area" rows="2" id="qiat-team" onchange="saveQiat('team', this.value)" placeholder="Who was involved? How did you engage stakeholders?"></textarea>
                                </div>
                            </div>
                        </div>

                        <div class="glass p-6 rounded-xl border-l-4 border-amber-500">
                            <h3 class="text-lg font-bold text-rcem-purple mb-1">Domain 3: Study</h3>
                            <p class="text-xs text-slate-500 mb-4">Data and Analysis.</p>
                            <div class="space-y-4">
                                <div>
                                    <label class="label">Measures Used</label>
                                    <textarea class="input-area" rows="2" id="qiat-measures" onchange="saveQiat('measures', this.value)" placeholder="Outcome, Process, and Balancing measures..."></textarea>
                                </div>
                                <div>
                                    <label class="label">Data Analysis & Interpretation</label>
                                    <textarea class="input-area" rows="3" id="qiat-analysis" onchange="saveQiat('analysis', this.value)" placeholder="What does the data show? Reference your charts."></textarea>
                                </div>
                            </div>
                        </div>

                        <div class="glass p-6 rounded-xl border-l-4 border-emerald-500">
                            <h3 class="text-lg font-bold text-rcem-purple mb-1">Domain 4: Act</h3>
                            <p class="text-xs text-slate-500 mb-4">Future cycles and Sustainability.</p>
                            <div class="space-y-4">
                                <div>
                                    <label class="label">Modifications & Next Steps</label>
                                    <textarea class="input-area" rows="3" id="qiat-modifications" onchange="saveQiat('modifications', this.value)" placeholder="How did you adapt based on results?"></textarea>
                                </div>
                                <div>
                                    <label class="label">Sustainability Plan</label>
                                    <textarea class="input-area" rows="2" id="qiat-sustainability" onchange="saveQiat('sustainability', this.value)" placeholder="How will the change be maintained?"></textarea>
                                </div>
                            </div>
                        </div>
                        
                        <div class="glass p-6 rounded-xl border-t-4 border-rcem-purple bg-slate-50 dark:bg-slate-800">
                            <h3 class="text-lg font-bold text-slate-800 dark:text-white mb-2">Assessment of QIAT</h3>
                            <p class="text-xs text-slate-500 mb-4">Self-assessment or Supervisor validation.</p>
                            <div class="flex gap-4 items-center mb-4">
                                <label class="flex items-center gap-2 cursor-pointer">
                                    <input type="radio" name="assessment_val" value="Satisfactory" onclick="saveQiat('assessment_val', 'Satisfactory')" id="qiat-assessment-sat">
                                    <span class="px-3 py-1 bg-green-100 text-green-800 rounded-full text-sm font-bold border border-green-200">Satisfactory</span>
                                </label>
                                <label class="flex items-center gap-2 cursor-pointer">
                                    <input type="radio" name="assessment_val" value="Unsatisfactory" onclick="saveQiat('assessment_val', 'Unsatisfactory')" id="qiat-assessment-unsat">
                                    <span class="px-3 py-1 bg-red-100 text-red-800 rounded-full text-sm font-bold border border-red-200">Unsatisfactory</span>
                                </label>
                            </div>
                            <div>
                                <label class="label">Comments / Feedback</label>
                                <textarea class="input-area bg-white" rows="2" id="qiat-assessment_comments" onchange="saveQiat('assessment_comments', this.value)" placeholder="Supervisor comments..."></textarea>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="view-data" class="view-section hidden fade-in">
                    <header class="mb-6 flex justify-between items-end">
                        <div>
                            <h2 class="text-3xl font-bold text-slate-800 dark:text-white">Data & SPC</h2>
                            <p class="text-slate-500 text-sm">Automated Statistical Process Control (Nelson Rules included)</p>
                        </div>
                        <button onclick="document.getElementById('bulk-modal').classList.remove('hidden')" class="bg-white border px-3 py-1.5 rounded shadow-sm text-sm">Bulk Import</button>
                    </header>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="glass rounded-xl p-6 h-fit">
                            <h3 class="font-bold mb-4">Add Data Point</h3>
                            <div class="space-y-3">
                                <input type="date" id="chart-date" class="input-field">
                                <input type="number" id="chart-value" class="input-field" placeholder="Value (e.g. % or count)">
                                <select id="chart-type" class="input-field">
                                    <option value="data">Data Point</option>
                                    <option value="intervention">Intervention Start</option>
                                </select>
                                <input type="text" id="chart-note" class="input-field hidden" placeholder="Intervention Name">
                                <button onclick="addDataPoint()" class="w-full bg-rcem-purple text-white py-2 rounded shadow">Add</button>
                            </div>
                            <div class="mt-4 pt-4 border-t">
                                <label class="label">Target (Goal line)</label>
                                <input type="number" id="chart-goal" class="input-field" onchange="updateGoal()" placeholder="e.g. 95">
                            </div>
                        </div>
                        <div class="lg:col-span-2 glass rounded-xl p-6 relative">
                            <canvas id="mainChart"></canvas>
                            <div id="spc-alerts" class="mt-4 space-y-2"></div>
                        </div>
                    </div>
                </div>

                <div id="view-tools" class="view-section hidden fade-in h-full flex flex-col">
                    <header class="mb-4 flex justify-between items-center">
                        <h2 class="text-3xl font-bold dark:text-white">Strategy Tools</h2>
                        <div class="flex bg-slate-200 dark:bg-slate-700 rounded p-1">
                            <button onclick="setTool('fishbone')" class="px-3 py-1 rounded text-sm font-medium transition-all" id="btn-fishbone">Fishbone</button>
                            <button onclick="setTool('driver')" class="px-3 py-1 rounded text-sm font-medium transition-all" id="btn-driver">Driver Diagram</button>
                        </div>
                    </header>
                    <div id="tool-controls" class="mb-4 flex gap-2 flex-wrap"></div>
                    <div id="tool-canvas" class="flex-1 glass rounded-xl flex items-center justify-center p-4 bg-white overflow-hidden"></div>
                </div>

                <div id="view-pdsa" class="view-section hidden fade-in">
                    <header class="mb-6 flex justify-between items-center">
                        <h2 class="text-3xl font-bold dark:text-white">PDSA Cycles</h2>
                        <button onclick="addPdsa()" class="bg-rcem-purple text-white px-4 py-2 rounded shadow flex items-center gap-2"><i data-lucide="plus" class="w-4 h-4"></i> New Cycle</button>
                    </header>
                    <div id="pdsa-list" class="space-y-4 max-w-4xl"></div>
                </div>

                 <div id="view-green" class="view-section hidden fade-in">
                    <header class="mb-6"><h2 class="text-3xl font-bold flex items-center gap-2 text-emerald-700 dark:text-emerald-400"><i data-lucide="leaf"></i> Green ED Calculator</h2></header>
                    <div class="glass p-8 max-w-2xl rounded-xl border border-emerald-100">
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <select id="green-item" class="input-field">
                                <option value="0.035">IV Cannula (Plastic)</option>
                                <option value="0.020">Blood Bottle</option>
                                <option value="0.150">IV Fluid Bag (1L)</option>
                                <option value="0.005">Paper Sheet (A4)</option>
                                <option value="1.0">Custom (1kg)</option>
                            </select>
                            <input type="number" id="green-qty" class="input-field" placeholder="Quantity saved">
                        </div>
                        <button onclick="calcCarbon()" class="bg-emerald-600 text-white px-6 py-2 rounded hover:bg-emerald-700 w-full font-bold">Calculate Savings</button>
                        <div id="green-result" class="mt-6 p-4 bg-emerald-50 dark:bg-emerald-900/30 rounded border border-emerald-200 hidden">
                            <p class="text-lg font-bold text-emerald-800 dark:text-emerald-200" id="green-single"></p>
                            <p class="text-sm text-emerald-600 dark:text-emerald-300 mt-2" id="green-annual"></p>
                        </div>
                    </div>
                </div>
                
                 <div id="view-poster" class="view-section hidden h-full fixed inset-0 z-50 bg-white overflow-auto p-4">
                     <div class="max-w-[1200px] mx-auto bg-white shadow-2xl p-8 min-h-screen" id="poster-content">
                         <div class="flex justify-between mb-8 border-b-4 border-rcem-purple pb-4">
                             <div>
                                 <h1 class="text-5xl font-bold text-rcem-purple mb-2" id="pos-title">Project Title</h1>
                                 <p class="text-xl text-slate-600" id="pos-team">Team Names</p>
                             </div>
                             <img src="https://iili.io/KGQOvkl.md.png" class="h-24">
                         </div>
                         <div class="grid grid-cols-3 gap-8">
                             <div class="space-y-8">
                                 <div><h2 class="text-2xl font-bold text-rcem-orange border-b-2 border-slate-200 pb-1 mb-2">Background</h2><p id="pos-prob" class="text-sm"></p></div>
                                 <div><h2 class="text-2xl font-bold text-rcem-orange border-b-2 border-slate-200 pb-1 mb-2">Aim</h2><p id="pos-aim" class="text-lg italic font-serif bg-slate-50 p-4 border-l-4 border-rcem-purple"></p></div>
                             </div>
                             <div class="space-y-8">
                                 <div><h2 class="text-2xl font-bold text-rcem-orange border-b-2 border-slate-200 pb-1 mb-2">Strategy</h2><p id="pos-strat" class="text-sm"></p></div>
                                 <div><h2 class="text-2xl font-bold text-rcem-orange border-b-2 border-slate-200 pb-1 mb-2">Results</h2><img id="pos-chart" class="w-full border"><p id="pos-res" class="text-sm mt-2 font-bold"></p></div>
                             </div>
                             <div class="space-y-8">
                                 <div><h2 class="text-2xl font-bold text-rcem-orange border-b-2 border-slate-200 pb-1 mb-2">PDSA Cycles</h2><div id="pos-pdsa" class="text-sm space-y-2"></div></div>
                                 <div><h2 class="text-2xl font-bold text-rcem-orange border-b-2 border-slate-200 pb-1 mb-2">Conclusion</h2><p id="pos-conc" class="text-sm"></p></div>
                             </div>
                         </div>
                     </div>
                     <div class="fixed bottom-4 right-4 flex gap-2 no-print">
                         <button onclick="window.print()" class="bg-rcem-purple text-white px-4 py-2 rounded shadow">Print / PDF</button>
                         <button onclick="router('dashboard')" class="bg-slate-700 text-white px-4 py-2 rounded shadow">Close</button>
                     </div>
                 </div>

            </div>

            <div id="guide-panel" class="w-0 bg-white dark:bg-slate-800 border-l border-slate-200 dark:border-slate-700 flex flex-col overflow-hidden relative shadow-xl">
                <div class="p-4 bg-amber-500 text-white flex justify-between items-center">
                    <h3 class="font-bold flex items-center gap-2"><i data-lucide="compass" class="w-5 h-5"></i> QIP Navigator</h3>
                    <button onclick="toggleGuide()"><i data-lucide="x" class="w-4 h-4"></i></button>
                </div>
                <div class="p-6 overflow-y-auto flex-1 space-y-8">
                    <div id="guide-content"></div>
                </div>
            </div>

        </main>
    </div>

    <div id="wizard-modal" class="fixed inset-0 bg-black/60 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white dark:bg-slate-800 w-full max-w-lg rounded-xl shadow-2xl overflow-hidden">
            <div class="bg-rcem-purple p-6 text-white">
                <h3 class="text-xl font-bold">New Project Setup</h3>
                <p class="text-indigo-200 text-sm">Select a template or start blank.</p>
            </div>
            <div class="p-6 space-y-4">
                <div>
                    <label class="label">Project Type</label>
                    <select id="wiz-type" class="input-field" onchange="updateWizTemplate()">
                        <option value="blank">Blank Project</option>
                        <option value="sepsis">RCEM National: Sepsis</option>
                        <option value="elderly">RCEM National: Care of Older People</option>
                        <option value="pain">RCEM National: Pain in Children</option>
                    </select>
                </div>
                <div><label class="label">Working Title</label><input id="wiz-title" class="input-field"></div>
                <div><label class="label">Initial Aim</label><textarea id="wiz-aim" rows="2" class="input-area"></textarea></div>
                <button onclick="finishWizard()" class="w-full bg-rcem-purple text-white py-3 rounded-lg font-bold shadow hover:bg-indigo-900 mt-4">Create Project</button>
            </div>
        </div>
    </div>
    
    <div id="bulk-modal" class="fixed inset-0 bg-black/60 z-50 hidden flex items-center justify-center p-4">
         <div class="bg-white p-6 rounded-xl max-w-md w-full shadow-2xl">
             <h3 class="font-bold mb-2">Paste Data (Date | Value)</h3>
             <textarea id="bulk-text" class="input-area h-40 font-mono text-sm" placeholder="2025-01-01	50&#10;2025-01-08	60"></textarea>
             <div class="flex justify-end gap-2 mt-4">
                 <button onclick="document.getElementById('bulk-modal').classList.add('hidden')" class="text-slate-500">Cancel</button>
                 <button onclick="processBulk()" class="bg-rcem-purple text-white px-4 py-2 rounded">Import</button>
             </div>
         </div>
    </div>

    <div id="report-template" class="hidden bg-white text-slate-900 p-12 font-serif text-sm">
        <h1 class="text-3xl font-sans font-bold text-rcem-purple mb-2" id="rep-title"></h1>
        <p class="mb-8 italic" id="rep-meta"></p>
        
        <h3 class="font-sans font-bold uppercase text-slate-500 border-b mb-2">1. Introduction (Plan)</h3>
        <p id="rep-intro" class="mb-4 text-justify"></p>
        <p class="font-bold bg-slate-50 p-2 border-l-2 border-rcem-purple mb-4" id="rep-aim"></p>
        
        <h3 class="font-sans font-bold uppercase text-slate-500 border-b mb-2">2. Methods & Strategy</h3>
        <p id="rep-methods" class="mb-4 text-justify"></p>
        
        <h3 class="font-sans font-bold uppercase text-slate-500 border-b mb-2">3. Results (Study)</h3>
        <img id="rep-chart" class="w-full mb-2 h-64 object-contain border">
        <p id="rep-results" class="mb-4 text-justify"></p>
        
        <h3 class="font-sans font-bold uppercase text-slate-500 border-b mb-2">4. Discussion (Act)</h3>
        <p id="rep-disc" class="mb-4 text-justify"></p>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

        // REAL FIREBASE CONFIG (Restored from your initial upload)
        const firebaseConfig = {
            apiKey: "AIzaSyBdu73Xb8xf4tJU4RLhJ82ANhLMI9eu0gI",
            authDomain: "rcem-qip-app.firebaseapp.com",
            projectId: "rcem-qip-app",
            storageBucket: "rcem-qip-app.firebasestorage.app",
            messagingSenderId: "231364231220",
            appId: "1:231364231220:web:6b2260e2c885d40ecb4a61",
            measurementId: "G-XHXTBQ29FX"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        let currentUser = null;
        let isDemo = false;
        let chartInstance = null;
        
        // Data Structure mirroring QIAT v7
        let project = {
            qiat: {
                title: "", lead: "", supervisors: "", date: "",
                problem: "", aim: "", strategy: "", // Plan
                interventions: "", team: "", // Do
                measures: "", analysis: "", // Study
                modifications: "", sustainability: "", // Act
                assessment_val: "", assessment_comments: "" // Assessment
            },
            data: [], // {date, value, type, note}
            pdsa: [], // {id, title, plan, do, study, act}
            tools: { 
                fishbone: { categories: [{id:1,text:"People",causes:[]},{id:2,text:"Methods",causes:[]},{id:3,text:"Environment",causes:[]},{id:4,text:"Equipment",causes:[]}] },
                drivers: { primary:[], secondary:[], changes:[] }
            },
            goal: null
        };

        // --- AUTH ---
        onAuthStateChanged(auth, (user) => {
            if(isDemo) return;
            currentUser = user;
            if(user) {
                document.getElementById('auth-screen').classList.add('hidden');
                document.getElementById('app-sidebar').classList.remove('hidden');
                document.getElementById('app-sidebar').classList.add('flex');
                initDB();
            } else {
                document.getElementById('auth-screen').classList.remove('hidden');
                document.getElementById('app-sidebar').classList.remove('flex');
                document.getElementById('app-sidebar').classList.add('hidden');
            }
        });

        document.getElementById('auth-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const pass = document.getElementById('password').value;
            try { await signInWithEmailAndPassword(auth, email, pass); } 
            catch { try { await createUserWithEmailAndPassword(auth, email, pass); } catch(err){ alert(err.message); } }
        });

        window.signOutApp = () => { isDemo = false; signOut(auth); location.reload(); };
        
        window.loadDemoMode = () => {
            isDemo = true; currentUser = {uid:'demo'};
            project = {
                qiat: {
                    title: "Improving Sepsis 6 Compliance", lead: "Dr. A. Demo", supervisors: "Dr. Cons", date: "2025-01-01",
                    problem: "Audit showed only 45% of Red Flag Sepsis patients received Abx within 1h. This increases mortality.",
                    aim: "To increase delivery of IV Abx within 1h for sepsis patients from 45% to 90% by Dec 2025.",
                    strategy: "Driver Diagram used. Focused on availability of equipment and staff awareness.",
                    interventions: "Launched Sepsis Grab Bags (Jan). Teaching Sessions (Feb).",
                    team: "Involved Matron, Pharmacist and Junior Docs.",
                    measures: "Outcome: % Abx in 1h. Balancing: Time to triage (did it increase?).",
                    analysis: "Run chart shows a shift of 6 points above median after intervention 1.",
                    modifications: "Grab bags were often empty, so introduced a checklist.",
                    sustainability: "Included in induction for new rotators.",
                    assessment_val: "Satisfactory", assessment_comments: "Excellent use of QI methodology."
                },
                data: [
                    {date:"2025-01-01", value:45, type:"data"}, {date:"2025-01-08", value:40, type:"data"}, {date:"2025-01-15", value:48, type:"data"},
                    {date:"2025-01-20", value:0, type:"intervention", note:"Sepsis Bags"},
                    {date:"2025-01-22", value:60, type:"data"}, {date:"2025-01-29", value:75, type:"data"}, {date:"2025-02-05", value:80, type:"data"},
                    {date:"2025-02-12", value:85, type:"data"}, {date:"2025-02-19", value:82, type:"data"}, {date:"2025-02-26", value:90, type:"data"}
                ],
                pdsa: [{id:1, title:"Cycle 1", plan:"Test Grab Bags", do:"Placed in Resus", study:"Used 5 times, worked well", act:"Expand to Majors"}],
                tools: { fishbone: {categories:[]}, drivers: {primary:[],secondary:[],changes:[]} },
                goal: 90
            };
            document.getElementById('auth-screen').classList.add('hidden');
            document.getElementById('app-sidebar').classList.remove('hidden');
            document.getElementById('app-sidebar').classList.add('flex');
            renderAll();
            showToast("Demo Mode Active");
        };

        // --- DATABASE SYNC ---
        function initDB() {
            onSnapshot(doc(db, 'projects', currentUser.uid), (doc) => {
                if(doc.exists()) { project = { ...project, ...doc.data() }; renderAll(); }
                else { document.getElementById('setup-card').classList.remove('hidden'); }
            });
        }
        async function save() { 
            if(isDemo) return; 
            await setDoc(doc(db, 'projects', currentUser.uid), project, {merge:true});
            const s = document.getElementById('save-status'); s.classList.add('animate-pulse-fast'); setTimeout(()=>s.classList.remove('animate-pulse-fast'),1000);
        }

        // --- CORE UI ---
        window.router = (view) => {
            if(view==='poster') { renderPoster(); document.getElementById('view-poster').classList.remove('hidden'); return; }
            document.getElementById('view-poster').classList.add('hidden');
            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
            document.getElementById(`view-${view}`).classList.remove('hidden');
            updateGuide(view);
            if(view==='data') renderChart();
            if(view==='tools') setTool('fishbone');
        };
        
        window.saveQiat = (field, val) => {
            // Privacy Filter
            if (/\b\d{10}\b/.test(val)) { 
                alert("PRIVACY WARNING: That looks like an NHS Number. Please remove it."); 
                document.getElementById(`qiat-${field}`).value = ""; 
                return; 
            }
            project.qiat[field] = val; save(); renderStats();
        };

        function renderAll() {
            // Fill Inputs
            Object.keys(project.qiat).forEach(k => { 
                const el = document.getElementById(`qiat-${k}`); 
                if(el) el.value = project.qiat[k]; 
            });
            // Radio buttons
            if(project.qiat.assessment_val === "Satisfactory") document.getElementById('qiat-assessment-sat').checked = true;
            if(project.qiat.assessment_val === "Unsatisfactory") document.getElementById('qiat-assessment-unsat').checked = true;

            renderStats(); renderPdsaList(); renderChart();
            document.getElementById('dash-aim-text').textContent = project.qiat.aim || "No aim defined.";
        }

        function renderStats() {
            const filled = Object.values(project.qiat).filter(v=>v).length;
            document.getElementById('stat-qiat').textContent = Math.round((filled/15)*100) + "%";
            document.getElementById('stat-data').textContent = project.data.filter(d=>d.type==='data').length;
            document.getElementById('stat-pdsa').textContent = project.pdsa.length;
        }

        // --- WIZARD & TEMPLATES ---
        window.openWizard = () => document.getElementById('wizard-modal').classList.remove('hidden');
        window.updateWizTemplate = () => {
            const t = document.getElementById('wiz-type').value;
            const title = document.getElementById('wiz-title');
            const aim = document.getElementById('wiz-aim');
            if(t === 'sepsis') {
                title.value = "Improving Sepsis 6 Delivery in the ED";
                aim.value = "To increase the % of patients with Red Flag Sepsis receiving antibiotics within 60 mins from X% to 90% by [Date].";
            } else if (t === 'elderly') {
                title.value = "Reducing Delirium in ED";
                aim.value = "To increase the completion of 4AT assessments for patients >75 from X% to 80% by [Date].";
            } else { title.value=""; aim.value=""; }
        };
        window.finishWizard = () => {
            project.qiat.title = document.getElementById('wiz-title').value;
            project.qiat.aim = document.getElementById('wiz-aim').value;
            save(); document.getElementById('wizard-modal').classList.add('hidden'); document.getElementById('setup-card').classList.add('hidden'); renderAll();
        };

        // --- DATA & SPC ENGINE ---
        window.addDataPoint = () => {
            const date = document.getElementById('chart-date').value;
            const val = document.getElementById('chart-value').value;
            const type = document.getElementById('chart-type').value;
            if(!date) return;
            project.data.push({date, value:val, type, note: type==='intervention'? prompt("Intervention Name:") : ""});
            save(); renderChart();
        };
        document.getElementById('chart-type').onchange = (e) => {
            document.getElementById('chart-value').classList.toggle('hidden', e.target.value==='intervention');
        };
        window.processBulk = () => {
            const lines = document.getElementById('bulk-text').value.split('\n');
            lines.forEach(l => { const [d,v] = l.split(/\t|,/); if(d&&v) project.data.push({date:d.trim(), value:v.trim(), type:'data'}); });
            save(); document.getElementById('bulk-modal').classList.add('hidden'); renderChart();
        }

        function renderChart() {
            const ctx = document.getElementById('mainChart').getContext('2d');
            if(chartInstance) chartInstance.destroy();
            
            const dataPts = project.data.filter(d=>d.type==='data').sort((a,b)=>new Date(a.date)-new Date(b.date));
            const values = dataPts.map(d=>parseFloat(d.value));
            
            // SPC Logic (Nelson Rules Lite)
            const median = values.length ? values.slice().sort((a,b)=>a-b)[Math.floor(values.length/2)] : 0;
            const bgColors = [];
            let shiftCount = 0; let lastSide = 0; // 1=above, -1=below
            
            values.forEach(v => {
                const side = v > median ? 1 : -1;
                if(side === lastSide) shiftCount++; else shiftCount = 1;
                lastSide = side;
                if(shiftCount >= 6) bgColors.push(side===1 ? '#10b981' : '#ef4444'); // Green/Red for shift
                else bgColors.push('#2d2e83');
            });

            // Annotations
            const annotations = {};
            project.data.filter(d=>d.type==='intervention').forEach((d,i)=>{
                annotations[`line${i}`] = { type:'line', xMin:d.date, xMax:d.date, borderColor:'#f36f21', borderDash:[5,5], label:{display:true, content:d.note, position:'start', backgroundColor:'#f36f21'} };
            });
            if(project.goal) annotations['goal'] = { type:'line', yMin:project.goal, yMax:project.goal, borderColor:'#10b981', borderWidth:2 };

            chartInstance = new Chart(ctx, {
                type: 'line',
                data: { 
                    labels: dataPts.map(d=>d.date),
                    datasets: [
                        { label: 'Measure', data: values, borderColor: '#2d2e83', pointBackgroundColor: bgColors, pointRadius: 6 },
                        { label: 'Median', data: Array(values.length).fill(median), borderColor: '#94a3b8', borderDash:[5,5], pointRadius:0 }
                    ]
                },
                options: { plugins: { annotation: { annotations } } }
            });
            
            // Text Analysis
            const hasShift = bgColors.some(c => c !== '#2d2e83');
            document.getElementById('spc-alerts').innerHTML = hasShift ? 
                `<div class="p-2 bg-emerald-100 text-emerald-800 rounded text-sm font-bold flex gap-2"><i data-lucide="trending-up"></i> SPC Alert: Significant Shift Detected (6+ points).</div>` : 
                `<div class="text-sm text-slate-500">No statistical shifts detected yet. Keep collecting data.</div>`;
            lucide.createIcons();
        }

        // --- STRATEGY TOOLS ---
        let currTool = 'fishbone';
        window.setTool = (t) => {
            currTool = t;
            document.getElementById('btn-fishbone').className = t==='fishbone'?'bg-rcem-purple text-white px-3 py-1 rounded shadow':'px-3 py-1';
            document.getElementById('btn-driver').className = t==='driver'?'bg-rcem-purple text-white px-3 py-1 rounded shadow':'px-3 py-1';
            renderTool();
        };
        async function renderTool() {
            const el = document.getElementById('tool-canvas');
            if(currTool === 'fishbone') {
                const cats = project.tools.fishbone.categories;
                let code = `mindmap\n  root((PROBLEM))\n`;
                cats.forEach(c => { code += `    ${c.text}\n`; c.causes.forEach(x => code+=`      ${x}\n`)});
                el.innerHTML = `<div class="mermaid">${code}</div>`;
                document.getElementById('tool-controls').innerHTML = cats.map(c=>`<button onclick="addFish(${c.id})" class="bg-indigo-50 text-indigo-700 border px-2 py-1 text-xs rounded">+ ${c.text}</button>`).join('');
            } else {
                const d = project.tools.drivers;
                let code = `graph LR\n  A[AIM] --> P[Primary]\n  P --> S[Secondary]\n  S --> C[Changes]\n`;
                d.primary.forEach((x,i)=>code+=`  P --> P${i}[${x}]\n`); d.secondary.forEach((x,i)=>code+=`  S --> S${i}[${x}]\n`);
                el.innerHTML = `<div class="mermaid">${code}</div>`;
                document.getElementById('tool-controls').innerHTML = `<button onclick="addDriver('primary')" class="bg-emerald-50 text-emerald-700 border px-2 py-1 text-xs">+ Primary</button><button onclick="addDriver('secondary')" class="bg-blue-50 text-blue-700 border px-2 py-1 text-xs">+ Secondary</button>`;
            }
            try { await mermaid.run(); } catch(e){}
        }
        window.addFish = (id) => { const v=prompt("Cause:"); if(v){project.tools.fishbone.categories.find(c=>c.id===id).causes.push(v); save(); renderTool();} };
        window.addDriver = (k) => { const v=prompt("Driver:"); if(v){project.tools.drivers[k].push(v); save(); renderTool();} };

        // --- PDSA ---
        window.addPdsa = () => { project.pdsa.unshift({id:Date.now(), title:`Cycle ${project.pdsa.length+1}`, plan:"", do:"", study:"", act:""}); save(); renderPdsaList(); };
        function renderPdsaList() {
            document.getElementById('pdsa-list').innerHTML = project.pdsa.map((p,i) => `
                <details class="glass rounded-xl mb-4 group">
                    <summary class="p-4 font-bold cursor-pointer flex justify-between bg-white/50">${p.title} <span class="text-xs font-normal text-slate-500">Click to expand</span></summary>
                    <div class="p-4 grid grid-cols-2 gap-4">
                        <textarea onchange="updatePdsa(${p.id},'plan',this.value)" class="input-area h-20" placeholder="Plan">${p.plan}</textarea>
                        <textarea onchange="updatePdsa(${p.id},'do',this.value)" class="input-area h-20" placeholder="Do">${p.do}</textarea>
                        <textarea onchange="updatePdsa(${p.id},'study',this.value)" class="input-area h-20" placeholder="Study">${p.study}</textarea>
                        <textarea onchange="updatePdsa(${p.id},'act',this.value)" class="input-area h-20" placeholder="Act">${p.act}</textarea>
                    </div>
                </details>
            `).join('');
        }
        window.updatePdsa = (id, f, v) => { project.pdsa.find(p=>p.id===id)[f]=v; save(); };

        // --- EXTRAS ---
        window.toggleGuide = () => {
            const p = document.getElementById('guide-panel');
            p.style.width = p.style.width === '350px' ? '0px' : '350px';
        };
        
        function updateGuide(view) {
            const content = {
                dashboard: `
                    <h4 class="font-bold text-lg mb-2">Welcome</h4>
                    <p class="text-sm mb-4">This dashboard is your mission control. Start by reviewing the cards.</p>
                    <div class="bg-indigo-50 p-3 rounded text-sm border-l-4 border-rcem-purple">
                        <strong>Tip:</strong> RCEM requires evidence of sustained change. Don't just stop at one cycle.
                    </div>
                `,
                qiat: `
                    <h4 class="font-bold text-lg mb-2">The QIAT Form</h4>
                    <p class="text-sm mb-4">This form mirrors the ePortfolio exactly. Fill it here, then copy-paste later.</p>
                    <h5 class="font-bold text-sm mt-4">Domain 1: Plan</h5>
                    <p class="text-xs text-slate-600 mb-2">Don't rush this. Spend 80% of your time planning. Do you have baseline data proving the problem?</p>
                    <h5 class="font-bold text-sm mt-4">SMART Aims</h5>
                    <ul class="list-disc pl-4 text-xs text-slate-600">
                        <li><strong>S</strong>pecific: Who/What/Where?</li>
                        <li><strong>M</strong>easurable: Numerical target.</li>
                        <li><strong>T</strong>ime: By when?</li>
                    </ul>
                `,
                data: `
                    <h4 class="font-bold text-lg mb-2">SPC Charts</h4>
                    <p class="text-sm mb-4">Run charts are the gold standard for healthcare improvement.</p>
                    <div class="bg-emerald-50 p-3 rounded text-sm border-l-4 border-emerald-500 mb-2">
                        <strong>Shift:</strong> 6 points in a row on one side of the median. This proves your change worked statistically.
                    </div>
                    <div class="bg-blue-50 p-3 rounded text-sm border-l-4 border-blue-500">
                        <strong>Trend:</strong> 5 points constantly going up or down.
                    </div>
                `
            };
            document.getElementById('guide-content').innerHTML = content[view] || `<p>Select a section to see guidance.</p>`;
        }

        window.calcCarbon = () => {
            const f = parseFloat(document.getElementById('green-item').value);
            const q = parseFloat(document.getElementById('green-qty').value);
            const res = (f * q).toFixed(2);
            document.getElementById('green-result').classList.remove('hidden');
            document.getElementById('green-single').textContent = `Saved: ${res} kg CO2e`;
            document.getElementById('green-annual').textContent = `Scaled up (if done daily for a year): ${(res * 365 / 1000).toFixed(2)} Tonnes CO2e`;
        }

        window.generateReport = () => {
             const t = document.getElementById('report-template');
             document.getElementById('rep-title').textContent = project.qiat.title;
             document.getElementById('rep-meta').textContent = `Lead: ${project.qiat.lead} | Date: ${new Date().toLocaleDateString()}`;
             document.getElementById('rep-intro').textContent = project.qiat.problem;
             document.getElementById('rep-aim').textContent = `AIM: ${project.qiat.aim}`;
             document.getElementById('rep-methods').textContent = `Strategy: ${project.qiat.strategy}. Interventions: ${project.qiat.interventions}`;
             document.getElementById('rep-results').textContent = project.qiat.analysis;
             document.getElementById('rep-disc').textContent = `Modifications: ${project.qiat.modifications}. Sustainability: ${project.qiat.sustainability}`;
             
             document.getElementById('rep-chart').src = document.getElementById('mainChart').toDataURL();
             t.classList.remove('hidden');
             html2pdf().from(t).save("RCEM_SQUIRE_Report.pdf").then(()=>t.classList.add('hidden'));
        };
        
        window.renderPoster = () => {
             document.getElementById('pos-title').textContent = project.qiat.title;
             document.getElementById('pos-team').textContent = project.qiat.lead + " & Team";
             document.getElementById('pos-prob').textContent = project.qiat.problem;
             document.getElementById('pos-aim').textContent = project.qiat.aim;
             document.getElementById('pos-strat').textContent = project.qiat.strategy;
             document.getElementById('pos-res').textContent = project.qiat.analysis;
             document.getElementById('pos-conc').textContent = project.qiat.sustainability;
             document.getElementById('pos-chart').src = document.getElementById('mainChart').toDataURL();
             document.getElementById('pos-pdsa').innerHTML = project.pdsa.slice(0,3).map(p=>`<div class="border-l-2 border-slate-300 pl-2"><strong>${p.title}:</strong> ${p.act}</div>`).join('');
        };

        window.toggleDarkMode = () => document.documentElement.classList.toggle('dark');
        
        // CSS Utils
        const style = document.createElement('style');
        style.innerHTML = `
            .input-field { width:100%; padding:0.5rem; border-radius:0.5rem; border:1px solid #cbd5e1; background:transparent; font-size:0.875rem; }
            .input-area { width:100%; padding:0.5rem; border-radius:0.5rem; border:1px solid #cbd5e1; background:transparent; font-size:0.875rem; }
            .label { display:block; font-size:0.875rem; font-weight:500; color:#475569; margin-bottom:0.25rem; }
            .dark .label { color:#cbd5e1; }
            @media print { .no-print { display: none; } }
        `;
        document.head.appendChild(style);
        
        lucide.createIcons();
        const showToast = (message) => {
            const el = document.createElement('div'); el.className = `px-4 py-2 rounded shadow-lg text-white text-sm font-medium mb-2 fade-in bg-rcem-purple`; el.innerHTML = message;
            document.getElementById('toast-container').appendChild(el); setTimeout(() => el.remove(), 3000);
        }
        mermaid.initialize({startOnLoad:false});
    </script>
</body>
</html>
