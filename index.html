<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RCEM QIP Assistant (WMEBEM)</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        slate: { 850: '#1e293b', 900: '#0f172a' },
                        rcem: { 
                            purple: '#2d2e83', 
                            orange: '#f36f21',
                            light: '#f4f6f8'
                        } 
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        serif: ['Merriweather', 'serif'],
                    },
                    animation: {
                        'pulse-fast': 'pulse 1s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'flash': 'flash 1s'
                    },
                    keyframes: {
                        flash: {
                            '0%, 100%': { opacity: '1' },
                            '50%': { opacity: '0.5', color: '#10b981' }
                        }
                    }
                }
            }
        }
    </script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Chart.js & Annotation Plugin -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>

    <!-- html2pdf -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <!-- SortableJS -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>

    <!-- Mermaid.js -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>

    <!-- Shepherd.js (Tour Guide) -->
    <script src="https://cdn.jsdelivr.net/npm/shepherd.js@10.0.1/dist/js/shepherd.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/shepherd.js@10.0.1/dist/css/shepherd.css"/>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Merriweather:wght@300;400;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; transition: background-color 0.3s, color 0.3s; }
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        .glass {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        .dark .glass {
            background: rgba(30, 41, 59, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        #toast-container { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 100; }

        .matrix-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: 1fr 1fr;
            gap: 2px;
            background-color: #cbd5e1;
            border: 2px solid #64748b;
        }
        .matrix-quadrant { background-color: white; padding: 1rem; min-height: 200px; position: relative; }

        /* Shepherd Tour Customization */
        .shepherd-element { background: #ffffff; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); border-radius: 0.5rem; }
        .shepherd-header { background: #f36f21; color: white; border-radius: 0.5rem 0.5rem 0 0; padding: 1rem; }
        .shepherd-text { padding: 1rem; font-size: 0.9rem; color: #1e293b; }
        .shepherd-button { background: #2d2e83; color: white; border-radius: 0.25rem; padding: 0.5rem 1rem; margin-right: 0.5rem; font-size: 0.8rem; }
        .shepherd-button:hover { background: #1e1e5f; }
        .shepherd-button-secondary { background: #e2e8f0; color: #475569; }

        /* Dark Mode overrides */
        .dark body { background-color: #0f172a; color: #e2e8f0; }
        .dark .matrix-quadrant { background-color: #1e293b; }
        .dark .matrix-grid { background-color: #475569; border-color: #64748b; }
        .dark input, .dark textarea, .dark select { background-color: rgba(30, 41, 59, 0.5); border-color: #475569; color: white; }
    </style>
</head>
<body class="bg-slate-100 text-slate-900 h-screen overflow-hidden flex flex-col bg-[url('https://www.transparenttextures.com/patterns/cubes.png')]">

    <!-- IG WARNING -->
    <div id="ig-banner" class="bg-amber-100 dark:bg-amber-900 border-b border-amber-200 dark:border-amber-800 text-amber-900 dark:text-amber-100 px-4 py-2 text-xs md:text-sm font-medium flex justify-between items-center z-50">
        <div class="flex items-center gap-2">
            <i data-lucide="shield-alert" class="w-4 h-4 text-amber-600 dark:text-amber-400"></i>
            <span>INFORMATION GOVERNANCE: Do <strong>NOT</strong> enter patient names, DoBs, or MRNs.</span>
        </div>
        <button onclick="document.getElementById('ig-banner').remove()" class="text-amber-700 hover:text-amber-900 dark:hover:text-amber-200"><i data-lucide="x" class="w-4 h-4"></i></button>
    </div>

    <div class="flex flex-1 overflow-hidden relative">
        
        <!-- LOGIN -->
        <div id="auth-screen" class="fixed inset-0 bg-slate-900/80 backdrop-blur-sm z-50 flex items-center justify-center p-4">
            <div class="glass bg-white rounded-xl shadow-2xl w-full max-w-md overflow-hidden fade-in">
                <div class="bg-white/50 p-8 text-center border-b border-slate-100/50">
                    <img src="https://iili.io/KGQOvkl.md.png" alt="WMEBEM Logo" class="h-20 mx-auto mb-4 object-contain">
                    <h1 class="text-2xl font-bold text-slate-900">RCEM QIP Assistant</h1>
                    <p class="text-slate-500 mt-1">Professional Portfolio & Audit Tool</p>
                </div>
                <div class="p-8">
                    <h2 id="auth-title" class="text-lg font-semibold text-slate-800 mb-6 text-center">Sign In</h2>
                    <div id="auth-message" class="hidden mb-4 p-3 rounded text-sm text-center"></div>
                    <form id="auth-form" class="space-y-4">
                        <input type="email" id="email" required class="w-full p-3 rounded-lg border border-slate-300 outline-none focus:ring-2 focus:ring-rcem-purple transition-all" placeholder="doctor@nhs.net">
                        <input type="password" id="password" class="w-full p-3 rounded-lg border border-slate-300 outline-none focus:ring-2 focus:ring-rcem-purple transition-all" placeholder="••••••••">
                        <button type="submit" id="auth-btn" class="w-full bg-rcem-purple hover:bg-indigo-900 text-white font-bold py-3 rounded-lg transition-all shadow-lg hover:shadow-xl"><span id="auth-btn-text">Sign In</span></button>
                    </form>
                    <button onclick="loadDemoMode()" class="w-full mt-3 bg-white border border-slate-300 text-slate-600 font-bold py-3 rounded-lg transition-all hover:bg-slate-50 flex justify-center items-center gap-2 group">
                        <i data-lucide="sparkles" class="w-4 h-4 text-amber-500 group-hover:text-amber-600"></i> See Example Project
                    </button>
                    <div class="mt-4 flex justify-between text-sm">
                        <button id="toggle-auth" class="text-rcem-purple hover:underline">Create Account</button>
                        <button id="forgot-password" class="text-slate-500 hover:text-slate-700">Forgot Password?</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- SIDEBAR -->
        <aside id="app-sidebar" class="hidden w-64 bg-slate-900/95 backdrop-blur-xl text-white flex-col h-full fixed left-0 top-0 z-10 shadow-2xl lg:static lg:flex border-r border-white/10">
            <div class="p-6 border-b border-white/10 flex flex-col items-center">
                <img src="https://iili.io/KGQOvkl.md.png" alt="WMEBEM Logo" class="h-14 mb-3 object-contain bg-white rounded-lg p-2 w-full shadow-inner">
                <div class="text-center">
                    <h1 class="font-bold text-lg tracking-tight">RCEM QIP</h1>
                    <p class="text-xs text-slate-400">West Midlands EM</p>
                </div>
            </div>
            <nav class="flex-1 p-4 space-y-1 overflow-y-auto" id="sidebar-nav">
                <button onclick="router('dashboard')" class="nav-btn w-full flex items-center gap-3 px-4 py-3 rounded-lg text-slate-300 hover:bg-white/10 transition-all" id="nav-dashboard"><i data-lucide="layout-dashboard" class="w-5 h-5"></i> <span class="font-medium">Dashboard</span></button>
                <button onclick="router('checklist')" class="nav-btn w-full flex items-center gap-3 px-4 py-3 rounded-lg text-slate-300 hover:bg-white/10 transition-all" id="nav-checklist"><i data-lucide="check-square" class="w-5 h-5"></i> <span class="font-medium">QIAT Checklist</span></button>
                <button onclick="router('data')" class="nav-btn w-full flex items-center gap-3 px-4 py-3 rounded-lg text-slate-300 hover:bg-white/10 transition-all" id="nav-data"><i data-lucide="bar-chart-2" class="w-5 h-5"></i> <span class="font-medium">Data & Charts</span></button>
                <button onclick="router('tools')" class="nav-btn w-full flex items-center gap-3 px-4 py-3 rounded-lg text-slate-300 hover:bg-white/10 transition-all" id="nav-tools"><i data-lucide="tool" class="w-5 h-5"></i> <span class="font-medium">Change Tools</span></button>
                <button onclick="router('gantt')" class="nav-btn w-full flex items-center gap-3 px-4 py-3 rounded-lg text-slate-300 hover:bg-white/10 transition-all" id="nav-gantt"><i data-lucide="calendar" class="w-5 h-5"></i> <span class="font-medium">Gantt Chart</span></button>
                <button onclick="router('pdsa')" class="nav-btn w-full flex items-center gap-3 px-4 py-3 rounded-lg text-slate-300 hover:bg-white/10 transition-all" id="nav-pdsa"><i data-lucide="refresh-cw" class="w-5 h-5"></i> <span class="font-medium">PDSA Cycles</span></button>
                <button onclick="router('green')" class="nav-btn w-full flex items-center gap-3 px-4 py-3 rounded-lg text-slate-300 hover:bg-white/10 transition-all" id="nav-green"><i data-lucide="leaf" class="w-5 h-5 text-emerald-400"></i> <span class="font-medium">Green ED</span></button>
                <button onclick="startTour()" class="nav-btn w-full flex items-center gap-3 px-4 py-3 rounded-lg text-amber-300 hover:bg-white/10 transition-all mt-4 border border-amber-500/30 bg-amber-500/10"><i data-lucide="help-circle" class="w-5 h-5"></i> <span class="font-medium">Interactive Guide</span></button>
            </nav>
            <div class="p-4 border-t border-white/10 bg-slate-900/50">
                <button onclick="toggleDarkMode()" class="w-full flex items-center gap-2 text-slate-400 hover:text-white hover:bg-white/10 px-4 py-2 rounded-lg transition-all text-sm mb-2"><i data-lucide="moon" class="w-4 h-4"></i> Dark Mode</button>
                <button id="logout-btn" class="w-full flex items-center gap-2 text-slate-400 hover:text-white hover:bg-white/10 px-4 py-2 rounded-lg transition-all text-sm"><i data-lucide="log-out" class="w-4 h-4"></i> Sign Out</button>
            </div>
        </aside>

        <!-- MAIN -->
        <main id="main-content" class="hidden flex-1 overflow-y-auto bg-slate-100/50 dark:bg-slate-900/50 relative w-full">
            <button id="mobile-menu-btn" class="lg:hidden absolute top-4 right-4 z-30 bg-slate-900 text-white p-2 rounded-md shadow-lg"><i data-lucide="menu"></i></button>

            <!-- Status Bar -->
            <div class="glass sticky top-0 z-20 px-8 py-3 flex justify-between items-center shadow-sm">
                <div class="flex items-center text-sm text-slate-500 dark:text-slate-400">
                    <span class="font-semibold text-slate-700 dark:text-slate-200 mr-2">Status:</span>
                    <span id="save-status" class="flex items-center gap-1 text-emerald-600 dark:text-emerald-400 transition-all"><i data-lucide="save" class="w-3 h-3"></i> Saved</span>
                </div>
                <div id="user-display" class="text-xs text-slate-400 font-mono"></div>
            </div>

            <div id="toast-container"></div>

            <div id="views-container" class="pb-20 p-4 md:p-8">
                
                <!-- 1. DASHBOARD -->
                <div id="view-dashboard" class="view-section space-y-6 fade-in">
                    <!-- Banner for Demo Mode -->
                    <div id="demo-banner" class="hidden bg-amber-100 border-l-4 border-amber-500 text-amber-700 p-4 rounded shadow-sm" role="alert">
                        <p class="font-bold">Demo Mode Active</p>
                        <p>You are viewing a model QIP example. Feel free to explore! Data changes will not be saved.</p>
                    </div>

                    <header class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                        <div>
                            <h2 class="text-3xl font-bold text-slate-800 dark:text-white tracking-tight">Dashboard</h2>
                            <p class="text-slate-500 dark:text-slate-400">QI Project Overview</p>
                        </div>
                        <div class="flex flex-wrap gap-2">
                             <button onclick="emailSupervisor()" class="bg-indigo-50 text-indigo-700 border border-indigo-200 hover:bg-indigo-100 flex items-center gap-2 text-sm px-4 py-2 rounded-lg shadow-sm transition-all"><i data-lucide="mail" class="w-4 h-4"></i> Email Supervisor</button>
                             <button id="btn-poster" onclick="router('poster')" class="bg-rcem-purple hover:bg-indigo-900 text-white flex items-center gap-2 text-sm px-4 py-2 rounded-lg shadow-md transition-all"><i data-lucide="layout" class="w-4 h-4"></i> Poster Mode</button>
                             <button id="btn-report" onclick="generateReport()" class="bg-white hover:bg-slate-50 text-slate-700 border border-slate-200 flex items-center gap-2 text-sm px-4 py-2 rounded-lg shadow-sm transition-all"><i data-lucide="file-text" class="w-4 h-4"></i> Report</button>
                             <button onclick="downloadJSON()" class="bg-slate-600 hover:bg-slate-700 text-white flex items-center gap-2 text-sm px-4 py-2 rounded-lg shadow-sm"><i data-lucide="download-cloud" class="w-4 h-4"></i> Backup</button>
                             <label class="bg-slate-200 hover:bg-slate-300 text-slate-700 flex items-center gap-2 text-sm px-4 py-2 rounded-lg shadow-sm cursor-pointer"><i data-lucide="upload-cloud" class="w-4 h-4"></i> Restore<input type="file" id="restore-input" class="hidden" onchange="restoreJSON(this)"></label>
                             <button onclick="resetProject()" class="text-slate-400 hover:text-red-600 flex items-center gap-2 text-sm border border-slate-200 dark:border-slate-700 px-3 py-2 rounded-lg hover:border-red-200"><i data-lucide="rotate-ccw" class="w-4 h-4"></i> Reset</button>
                        </div>
                    </header>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6" id="stats-grid"></div>
                    
                    <div id="aim-card" class="glass rounded-xl p-6 shadow-sm">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-bold text-slate-800 dark:text-white flex items-center gap-2"><i data-lucide="target" class="text-rcem-purple dark:text-indigo-400"></i> Project Aim</h3>
                            <button id="btn-smart" onclick="openSmartWizard()" class="text-xs bg-indigo-100 text-indigo-700 px-2 py-1 rounded hover:bg-indigo-200">SMART Wizard</button>
                        </div>
                        <div id="dashboard-aim" class="p-4 bg-indigo-50/50 dark:bg-slate-900 rounded-lg border border-indigo-100 dark:border-slate-700 text-indigo-900 dark:text-indigo-100 italic font-serif">No aim defined.</div>
                    </div>

                    <!-- Suggested Next Step (Intelligent Guidance) -->
                    <div id="next-step-card" class="glass rounded-xl p-6 border-l-4 border-emerald-500 shadow-sm hidden">
                        <h4 class="font-bold text-slate-800 dark:text-white flex items-center gap-2"><i data-lucide="lightbulb" class="text-emerald-500 w-5 h-5"></i> Suggested Next Step</h4>
                        <p id="next-step-text" class="text-slate-600 dark:text-slate-300 mt-1 text-sm"></p>
                        <button id="next-step-btn" class="mt-3 text-sm bg-emerald-100 text-emerald-800 px-3 py-1.5 rounded hover:bg-emerald-200 font-medium transition-colors">Go</button>
                    </div>

                    <!-- Get Started Guide (Shows if no data) -->
                    <div id="get-started-card" class="glass rounded-xl p-8 border border-dashed border-slate-300 dark:border-slate-600 text-center hidden">
                        <div class="w-16 h-16 bg-indigo-100 text-indigo-600 rounded-full flex items-center justify-center mx-auto mb-4"><i data-lucide="rocket" class="w-8 h-8"></i></div>
                        <h3 class="text-xl font-bold text-slate-800 dark:text-white mb-2">Ready to Improve Care?</h3>
                        <p class="text-slate-500 dark:text-slate-400 mb-6 max-w-md mx-auto">Start by defining your project in the Checklist, then build a Driver Diagram to plan your strategy.</p>
                        <button onclick="router('checklist')" class="bg-rcem-purple text-white px-6 py-2 rounded-lg shadow hover:bg-indigo-900">Start Checklist</button>
                    </div>
                </div>

                <!-- 2. CHECKLIST -->
                <div id="view-checklist" class="view-section hidden max-w-4xl mx-auto fade-in">
                    <div class="mb-8">
                        <h2 class="text-3xl font-bold text-slate-800 dark:text-white">QIAT Checklist</h2>
                        <p class="text-slate-500 dark:text-slate-400">Aligned with RCEM Curriculum requirements.</p>
                    </div>
                    <div id="checklist-container" class="space-y-4"></div>
                </div>

                <!-- 3. DATA & CHARTS -->
                <div id="view-data" class="view-section hidden fade-in">
                    <header class="mb-6 flex justify-between items-end">
                        <div>
                            <h2 class="text-3xl font-bold text-slate-800 dark:text-white">Data & Charts</h2>
                            <p class="text-slate-500 dark:text-slate-400">Run Charts (SPC) with Annotated Interventions.</p>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="openBulkImport()" class="bg-indigo-50 text-indigo-700 border border-indigo-200 px-3 py-1.5 rounded text-sm hover:bg-indigo-100"><i data-lucide="table" class="w-4 h-4 inline"></i> Bulk Import</button>
                            <button onclick="setChartMode('run')" id="btn-chart-run" class="bg-rcem-purple text-white px-3 py-1.5 rounded text-sm shadow">Run Chart</button>
                            <button onclick="setChartMode('pareto')" id="btn-chart-pareto" class="bg-slate-200 text-slate-700 px-3 py-1.5 rounded text-sm">Pareto</button>
                            <button onclick="exportCSV()" class="text-indigo-600 dark:text-indigo-400 border border-indigo-200 dark:border-slate-600 px-3 py-1.5 rounded bg-indigo-50 dark:bg-slate-800 text-sm"><i data-lucide="download" class="w-4 h-4"></i> CSV</button>
                        </div>
                    </header>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div class="glass rounded-xl p-6 shadow-sm h-fit">
                            <h3 id="chart-input-title" class="font-bold text-lg mb-4 text-slate-800 dark:text-white">Add Data Point</h3>
                            <div id="input-run" class="space-y-4">
                                <input type="date" id="chart-date" class="w-full rounded border-slate-300 dark:border-slate-600 border p-2 text-sm bg-transparent" onchange="validateDate(this)">
                                <input type="number" id="chart-value" class="w-full rounded border-slate-300 dark:border-slate-600 border p-2 text-sm bg-transparent" placeholder="Measurement (Value/%)">
                                <select id="chart-type" class="w-full rounded border-slate-300 dark:border-slate-600 border p-2 text-sm bg-transparent">
                                    <option value="data">Data Point</option>
                                    <option value="intervention">Intervention Start (PDSA)</option>
                                </select>
                                <input type="text" id="chart-note" class="w-full rounded border-slate-300 dark:border-slate-600 border p-2 text-sm bg-transparent" placeholder="Label (e.g. PDSA 1)">
                                <button onclick="addDataPoint()" class="w-full bg-rcem-purple text-white py-2 rounded hover:bg-indigo-900 shadow transition-all">Add Point</button>
                                <div class="border-t pt-4 mt-4">
                                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Target / Goal</label>
                                    <input type="number" id="chart-goal" class="w-full rounded border-slate-300 dark:border-slate-600 border p-2 text-sm bg-transparent" placeholder="e.g. 95" onchange="updateGoal()">
                                </div>
                            </div>
                            <div id="input-pareto" class="space-y-4 hidden">
                                <input type="text" id="pareto-cat" class="w-full rounded border-slate-300 dark:border-slate-600 border p-2 text-sm bg-transparent" placeholder="Category (e.g., Lack of Staff)">
                                <input type="number" id="pareto-count" class="w-full rounded border-slate-300 dark:border-slate-600 border p-2 text-sm bg-transparent" placeholder="Count">
                                <button onclick="addParetoData()" class="w-full bg-rcem-purple text-white py-2 rounded hover:bg-indigo-900 shadow">Add Data</button>
                            </div>
                            <div class="mt-8 max-h-60 overflow-y-auto" id="data-history-list"></div>
                        </div>
                        <div class="lg:col-span-2 glass rounded-xl p-6 shadow-sm">
                            <canvas id="mainChart"></canvas>
                            <div id="chart-legend" class="mt-4 text-xs text-slate-500 text-center font-medium"></div>
                        </div>
                    </div>
                </div>

                <!-- 4. CHANGE TOOLS -->
                <div id="view-tools" class="view-section hidden h-full flex flex-col fade-in">
                    <header class="mb-6 flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                        <div>
                            <h2 class="text-3xl font-bold text-slate-800 dark:text-white">Change Tools</h2>
                            <p class="text-slate-500 dark:text-slate-400">Mermaid.js Vector Diagrams.</p>
                        </div>
                        <div class="flex gap-2 items-center">
                            <button onclick="downloadDiagram()" class="text-sm bg-white border border-slate-300 text-slate-700 px-3 py-1.5 rounded shadow-sm hover:bg-slate-50"><i data-lucide="image" class="w-4 h-4 inline mr-1"></i> Download PNG</button>
                            <div class="bg-slate-200 dark:bg-slate-700 p-1 rounded-lg flex text-xs md:text-sm">
                                <button onclick="setToolMode('fishbone')" id="btn-fishbone" class="tool-tab px-3 py-1.5 rounded-md font-medium transition-all">Fishbone</button>
                                <button onclick="setToolMode('driver')" id="btn-driver" class="tool-tab px-3 py-1.5 rounded-md transition-all">Driver Diagram</button>
                                <button onclick="setToolMode('whys')" id="btn-whys" class="tool-tab px-3 py-1.5 rounded-md transition-all">5 Whys</button>
                                <button onclick="setToolMode('force')" id="btn-force" class="tool-tab px-3 py-1.5 rounded-md transition-all">Force Field</button>
                            </div>
                        </div>
                    </header>
                    
                    <!-- Diagram Inputs -->
                    <div id="tool-controls" class="mb-4 bg-white dark:bg-slate-800 p-4 rounded-lg border border-slate-200 dark:border-slate-700 flex flex-wrap gap-4 items-end">
                        <!-- Dynamic inputs injected by JS -->
                    </div>

                    <div id="tool-canvas" class="flex-1 glass rounded-xl shadow-sm p-4 md:p-8 overflow-auto relative min-h-[500px] flex items-center justify-center bg-white">
                        <!-- Mermaid renders here -->
                    </div>
                </div>

                <!-- 5. GANTT -->
                <div id="view-gantt" class="view-section hidden fade-in">
                    <header class="mb-6"><h2 class="text-3xl font-bold text-slate-800 dark:text-white">Gantt Chart</h2></header>
                    <div class="glass p-4 rounded-xl shadow-sm mb-8 flex flex-wrap gap-4 items-end">
                        <input type="text" id="gantt-name" class="flex-1 min-w-[200px] rounded border-slate-300 dark:border-slate-600 border p-2 text-sm bg-transparent" placeholder="Task Name (e.g., Literature Review)">
                        <input type="date" id="gantt-start" class="rounded border-slate-300 dark:border-slate-600 border p-2 text-sm bg-transparent">
                        <input type="date" id="gantt-end" class="rounded border-slate-300 dark:border-slate-600 border p-2 text-sm bg-transparent">
                        <select id="gantt-status" class="rounded border-slate-300 dark:border-slate-600 border p-2 text-sm bg-white dark:bg-slate-700"><option>Planned</option><option>In Progress</option><option>Complete</option></select>
                        <button onclick="addGanttTask()" class="bg-rcem-purple text-white px-4 py-2 rounded shadow hover:bg-indigo-900 flex items-center gap-2"><i data-lucide="plus" class="w-4 h-4"></i> Add</button>
                    </div>
                    <div class="glass rounded-xl shadow-sm overflow-hidden">
                        <div class="p-4 border-b border-slate-200 dark:border-slate-700 bg-slate-50/50 dark:bg-slate-800 font-medium text-slate-500 flex justify-between"><span>Task List</span><span id="gantt-range">Timeline</span></div>
                        <div id="gantt-chart-area" class="relative min-h-[300px] p-4"></div>
                    </div>
                </div>

                <!-- 6. PDSA -->
                <div id="view-pdsa" class="view-section hidden fade-in">
                     <header class="mb-6 flex justify-between items-center">
                        <div><h2 class="text-3xl font-bold text-slate-800 dark:text-white">PDSA Cycles</h2><p class="text-slate-500 dark:text-slate-400">Iterative improvement.</p></div>
                        <button onclick="addPDSACycle()" class="bg-rcem-purple text-white px-4 py-2 rounded shadow hover:bg-indigo-900 flex items-center gap-2"><i data-lucide="plus" class="w-4 h-4"></i> New Cycle</button>
                    </header>
                    <div id="pdsa-list" class="space-y-4 max-w-4xl"></div>
                </div>

                <!-- 7. GREEN ED -->
                <div id="view-green" class="view-section hidden fade-in">
                    <div class="max-w-4xl mx-auto">
                        <header class="mb-6"><h2 class="text-3xl font-bold text-slate-800 dark:text-white flex items-center gap-2"><i data-lucide="leaf" class="text-emerald-500"></i> Green ED Calculator</h2></header>
                        <div class="glass border border-emerald-100 dark:border-emerald-800 p-6 rounded-xl mb-6">
                            <h3 class="font-bold text-emerald-900 dark:text-emerald-100 mb-4">Calculate Savings</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                <select id="green-item" class="w-full p-2 rounded border border-emerald-200 dark:border-emerald-700 dark:bg-slate-800"><option value="0.035">IV Cannula (Plastic) - 35g</option><option value="0.020">Blood Bottle - 20g</option><option value="0.005">Paper Sheet (A4) - 5g</option><option value="0.150">IV Fluid Bag (1L) - 150g</option><option value="0.170">Car Mile (Avg) - 170g</option></select>
                                <input type="number" id="green-qty" class="w-full p-2 rounded border border-emerald-200 dark:border-emerald-700 dark:bg-slate-800" placeholder="Qty">
                            </div>
                            <button onclick="calcCarbon()" class="bg-emerald-600 text-white px-4 py-2 rounded hover:bg-emerald-700">Calculate</button>
                            <div id="green-result" class="mt-4 font-bold text-lg text-emerald-800 dark:text-emerald-300 hidden"></div>
                        </div>
                    </div>
                </div>

                <!-- 8. POSTER MODE -->
                <div id="view-poster" class="view-section hidden h-screen fixed inset-0 z-[100] bg-gray-100 overflow-auto">
                    <div class="bg-gray-800 text-white p-4 flex justify-between items-center no-print sticky top-0 z-50">
                        <span>Poster Preview (A0 Landscape)</span>
                        <div>
                            <button onclick="window.print()" class="bg-white text-gray-900 px-4 py-2 rounded mr-2">Print / Save PDF</button>
                            <button onclick="router('dashboard')" class="text-gray-300 hover:text-white">Close</button>
                        </div>
                    </div>
                    <div class="poster-grid font-sans" id="poster-content">
                        <!-- Header -->
                        <div class="col-span-4 bg-rcem-purple text-white p-6 rounded-lg flex justify-between items-center">
                            <div>
                                <h1 class="text-4xl font-bold mb-2" id="poster-title">Project Title</h1>
                                <p class="text-xl" id="poster-team">Team Names</p>
                            </div>
                            <img src="https://iili.io/KGQOvkl.md.png" class="h-24 bg-white p-2 rounded">
                        </div>
                        
                        <!-- Col 1 -->
                        <div class="poster-card flex flex-col gap-4">
                            <h2 class="text-2xl font-bold text-rcem-purple border-b-2 border-rcem-purple pb-2">Background</h2>
                            <p id="poster-problem" class="text-sm"></p>
                            <h2 class="text-2xl font-bold text-rcem-purple border-b-2 border-rcem-purple pb-2 mt-4">Aim</h2>
                            <p id="poster-aim" class="font-bold text-lg italic"></p>
                        </div>

                        <!-- Col 2 -->
                        <div class="poster-card flex flex-col gap-4">
                            <h2 class="text-2xl font-bold text-rcem-purple border-b-2 border-rcem-purple pb-2">Strategy</h2>
                            <div id="poster-driver" class="flex-1 flex items-center justify-center overflow-hidden"></div>
                        </div>

                        <!-- Col 3 -->
                        <div class="poster-card flex flex-col gap-4">
                            <h2 class="text-2xl font-bold text-rcem-purple border-b-2 border-rcem-purple pb-2">Results</h2>
                            <img id="poster-chart" class="w-full object-contain">
                            <p id="poster-results" class="text-sm mt-2"></p>
                        </div>

                        <!-- Col 4 -->
                        <div class="poster-card flex flex-col gap-4">
                            <h2 class="text-2xl font-bold text-rcem-purple border-b-2 border-rcem-purple pb-2">Conclusion</h2>
                            <p id="poster-learning" class="text-sm"></p>
                            <h2 class="text-2xl font-bold text-rcem-purple border-b-2 border-rcem-purple pb-2 mt-4">PDSA Cycles</h2>
                            <div id="poster-pdsa" class="text-xs space-y-1"></div>
                        </div>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <!-- SMART WIZARD -->
    <div id="smart-modal" class="fixed inset-0 bg-black/50 z-[60] hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white dark:bg-slate-800 w-full max-w-lg rounded-xl shadow-2xl p-6">
            <h3 class="text-xl font-bold mb-4 dark:text-white">Build SMART Aim</h3>
            <div class="space-y-3">
                <input id="smart-s" class="w-full border p-2 rounded dark:bg-slate-700 dark:border-slate-600" placeholder="Specific: What? (e.g. Sepsis Abx)">
                <input id="smart-m" class="w-full border p-2 rounded dark:bg-slate-700 dark:border-slate-600" placeholder="Measurable: Target %? (e.g. 95%)">
                <input id="smart-p" class="w-full border p-2 rounded dark:bg-slate-700 dark:border-slate-600" placeholder="Population: Who? (e.g. Adult Patients)">
                <input id="smart-t" class="w-full border p-2 rounded dark:bg-slate-700 dark:border-slate-600" placeholder="Time: By when? (e.g. Aug 2025)">
            </div>
            <div class="mt-6 flex justify-end gap-2">
                <button onclick="document.getElementById('smart-modal').classList.add('hidden')" class="px-4 py-2 text-slate-500">Cancel</button>
                <button onclick="saveSmartAim()" class="px-4 py-2 bg-rcem-purple text-white rounded">Save Aim</button>
            </div>
        </div>
    </div>

    <!-- BULK IMPORT MODAL -->
    <div id="bulk-modal" class="fixed inset-0 bg-black/50 z-[60] hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white dark:bg-slate-800 w-full max-w-lg rounded-xl shadow-2xl p-6">
            <h3 class="text-xl font-bold mb-4 dark:text-white">Bulk Data Import</h3>
            <p class="text-sm text-slate-500 mb-2">Paste 2 columns from Excel (Date | Value):</p>
            <textarea id="bulk-text" rows="8" class="w-full border p-2 rounded dark:bg-slate-700 dark:border-slate-600 text-sm font-mono" placeholder="2025-01-01	45&#10;2025-01-08	50&#10;..."></textarea>
            <div class="mt-4 flex justify-end gap-2">
                <button onclick="document.getElementById('bulk-modal').classList.add('hidden')" class="px-4 py-2 text-slate-500">Cancel</button>
                <button onclick="handleBulkImport()" class="px-4 py-2 bg-rcem-purple text-white rounded">Import Data</button>
            </div>
        </div>
    </div>

    <!-- GUIDE MODAL -->
    <div id="guide-modal" class="fixed inset-0 bg-black/50 z-[60] hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white dark:bg-slate-800 w-full max-w-2xl rounded-xl shadow-2xl p-8 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold dark:text-white text-rcem-purple">RCEM QIP Quick Guide</h2>
                <button onclick="document.getElementById('guide-modal').classList.add('hidden')"><i data-lucide="x" class="dark:text-white"></i></button>
            </div>
            <div class="space-y-6 text-sm text-slate-600 dark:text-slate-300">
                <div class="flex gap-4">
                    <div class="bg-indigo-100 text-indigo-700 font-bold w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0">1</div>
                    <div>
                        <h4 class="font-bold text-slate-800 dark:text-white text-lg">Define & Diagnose</h4>
                        <p class="mb-2">Start with the <strong>QIAT Checklist</strong>. Describe the problem using local evidence.</p>
                        <p>Use the <strong>Change Tools</strong> (Fishbone, 5 Whys) to find the root cause, not just the symptoms.</p>
                    </div>
                </div>
                <div class="flex gap-4">
                    <div class="bg-indigo-100 text-indigo-700 font-bold w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0">2</div>
                    <div>
                        <h4 class="font-bold text-slate-800 dark:text-white text-lg">Plan Strategy</h4>
                        <p class="mb-2">Use the <strong>SMART Wizard</strong> on the dashboard to set a clear aim.</p>
                        <p>Build a <strong>Driver Diagram</strong> in Tools to map out your primary drivers and change ideas.</p>
                    </div>
                </div>
                <div class="flex gap-4">
                    <div class="bg-indigo-100 text-indigo-700 font-bold w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0">3</div>
                    <div>
                        <h4 class="font-bold text-slate-800 dark:text-white text-lg">Measure & Act</h4>
                        <p class="mb-2">Log your changes in <strong>PDSA Cycles</strong>.</p>
                        <p>Enter data into <strong>Data & Charts</strong>. Mark points as "Intervention Start" to see vertical lines on your Run Chart. Look for red points—they mean statistical improvement!</p>
                    </div>
                </div>
                <div class="flex gap-4">
                    <div class="bg-indigo-100 text-indigo-700 font-bold w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0">4</div>
                    <div>
                        <h4 class="font-bold text-slate-800 dark:text-white text-lg">Report</h4>
                        <p>Use <strong>Poster Mode</strong> for conferences or <strong>Generate Report</strong> for your ePortfolio/ARCP.</p>
                    </div>
                </div>
            </div>
            <button onclick="document.getElementById('guide-modal').classList.add('hidden')" class="w-full mt-8 bg-rcem-purple text-white py-3 rounded-lg font-bold">Got it, let's start</button>
        </div>
    </div>

    <!-- REPORT TEMPLATE (Journal Style) -->
    <div id="report-template" class="hidden bg-white p-12 max-w-4xl mx-auto text-slate-900 font-serif leading-relaxed">
        <div class="flex justify-between items-center border-b-4 border-rcem-purple pb-6 mb-8">
            <div>
                <h1 class="text-4xl font-bold mb-2 font-sans text-rcem-purple">QI Project Report</h1>
                <p class="text-slate-600 italic">Generated via RCEM QIP Assistant</p>
            </div>
            <img src="https://iili.io/KGQOvkl.md.png" class="h-20 object-contain">
        </div>
        <div class="mb-8 font-sans bg-slate-50 p-6 rounded-lg border border-slate-200">
            <h2 class="text-2xl font-bold mb-2" id="rep-title"></h2>
            <p><strong>Lead:</strong> <span id="rep-lead"></span> | <strong>Team:</strong> <span id="rep-team"></span></p>
        </div>
        <div class="columns-2 gap-8 mb-8 text-justify text-sm">
            <h3 class="font-sans font-bold text-lg text-rcem-purple mb-2 uppercase tracking-wide border-b border-slate-300">1. Problem</h3>
            <p id="rep-problem" class="mb-4"></p>
            <h3 class="font-sans font-bold text-lg text-rcem-purple mb-2 uppercase tracking-wide border-b border-slate-300">2. Aim</h3>
            <p id="rep-aim" class="mb-4 font-bold italic"></p>
            <h3 class="font-sans font-bold text-lg text-rcem-purple mb-2 uppercase tracking-wide border-b border-slate-300">3. Strategy</h3>
            <p id="rep-driver-list" class="mb-4"></p>
        </div>
        <div class="mb-8 break-inside-avoid">
            <h3 class="font-sans font-bold text-lg text-rcem-purple mb-2 uppercase tracking-wide border-b border-slate-300">4. Results (Run Chart)</h3>
            <img id="rep-chart-img" class="w-full h-auto border border-slate-200 mb-2">
            <p id="rep-results" class="text-sm italic"></p>
        </div>
        <div class="mb-8">
            <h3 class="font-sans font-bold text-lg text-rcem-purple mb-2 uppercase tracking-wide border-b border-slate-300">5. PDSA Cycles</h3>
            <div id="rep-pdsa-list" class="text-sm space-y-2"></div>
        </div>
        <div class="mb-8">
            <h3 class="font-sans font-bold text-lg text-rcem-purple mb-2 uppercase tracking-wide border-b border-slate-300">6. Conclusion</h3>
            <p id="rep-learning" class="text-sm"></p>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBdu73Xb8xf4tJU4RLhJ82ANhLMI9eu0gI",
            authDomain: "rcem-qip-app.firebaseapp.com",
            projectId: "rcem-qip-app",
            storageBucket: "rcem-qip-app.firebasestorage.app",
            messagingSenderId: "231364231220",
            appId: "1:231364231220:web:6b2260e2c885d40ecb4a61",
            measurementId: "G-XHXTBQ29FX"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let isDemo = false;
        let projectData = {
            checklist: {},
            fishbone: { categories: [] },
            drivers: { primary: [], secondary: [], changes: [] },
            forcefield: { driving: [], restraining: [] },
            swot: { s: [], w: [], o: [], t: [] },
            fiveWhys: ["","","","",""],
            gantt: [],
            pdsa: [],
            chartData: [],
            paretoData: [],
            chartGoal: null
        };
        let chartMode = 'run';
        let toolMode = 'fishbone'; 
        let authMode = 'signin';
        let chartInstance = null;
        let tour;

        const escapeHtml = (unsafe) => { if(!unsafe) return ''; return unsafe.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;"); }
        const showToast = (message) => {
            const el = document.createElement('div'); el.className = `px-4 py-2 rounded shadow-lg text-white text-sm font-medium mb-2 fade-in bg-rcem-purple`; el.innerHTML = message;
            document.getElementById('toast-container').appendChild(el); setTimeout(() => el.remove(), 3000);
        }

        mermaid.initialize({ startOnLoad: false, theme: 'neutral', securityLevel: 'loose' });

        // --- AUTH ---
        onAuthStateChanged(auth, (user) => {
            if(isDemo) return; 
            currentUser = user;
            if (user) {
                showApp();
                initRealtimeListener();
                if(!localStorage.getItem('rcem_tour_done')) {
                    document.getElementById('guide-modal').classList.remove('hidden');
                    localStorage.setItem('rcem_tour_done', 'true');
                }
            } else {
                showAuth();
            }
        });

        function showApp() {
            document.getElementById('auth-screen').classList.add('hidden');
            document.getElementById('app-sidebar').classList.remove('hidden');
            document.getElementById('app-sidebar').classList.add('flex');
            document.getElementById('main-content').classList.remove('hidden');
            document.getElementById('user-display').textContent = currentUser ? currentUser.email : "Demo User";
        }

        function showAuth() {
            document.getElementById('auth-screen').classList.remove('hidden');
            document.getElementById('app-sidebar').classList.remove('flex');
            document.getElementById('app-sidebar').classList.add('hidden');
            document.getElementById('main-content').classList.add('hidden');
        }

        window.loadDemoMode = () => {
            isDemo = true;
            currentUser = { email: "demo@rcem.ac.uk", uid: "demo" };
            projectData = {
                checklist: {
                    title: "Improving Sepsis 6 Bundle Delivery", lead: "Dr. A. Smith", team: "Sr. Nurse Jones, Dr. B. Patel", aim: "To increase Sepsis 6 delivery within 1 hour from 45% to 90% by Dec 2025.",
                    problem_desc: "Local audit showed only 45% of patients with Red Flag Sepsis received antibiotics within 1 hour. This increases mortality risk.", results_summary: "Achieved 85% compliance after 3 cycles."
                },
                fishbone: { categories: [{id:1, text:"People", causes:["Locum staff unaware of protocol", "Nursing shortage"]}, {id:2, text:"Methods", causes:["No clear pathway", "Paper notes lost"]}, {id:3, text:"Equipment", causes:["Missing blood culture bottles", "Antibiotics locked away"]}, {id:4, text:"Environment", causes:["ED Overcrowding", "No private space"]}] },
                drivers: { primary: ["Reliable Identification", "Timely Delivery"], secondary: ["Triage Screening", "Grab Bags Available", "Staff Education"], changes: ["Sepsis Stamp at Triage", "Pre-made Sepsis 6 Kits", "10-min teaching sessions"] },
                chartData: [
                    {date:"2025-01-01", value:45, type:"data"}, {date:"2025-01-08", value:42, type:"data"},
                    {date:"2025-01-15", value:50, type:"data"}, {date:"2025-01-16", value:0, type:"intervention", note:"PDSA 1: Sepsis Stamp"},
                    {date:"2025-01-22", value:65, type:"data"}, {date:"2025-01-29", value:70, type:"data"},
                    {date:"2025-02-05", value:85, type:"data"}, {date:"2025-02-12", value:88, type:"data"}
                ],
                pdsa: [{id:1, title:"Cycle 1: Sepsis Stamp", date:"2025-01-16", plan:"Introduce a 'Sepsis Suspected' stamp for triage notes to prompt senior review.", do:"Trialled for 1 week in Majors A.", study:"Compliance rose to 65%. Nurses found it helpful.", act:"Adopt and roll out to all areas."}],
                chartGoal: 90,
                gantt: [], paretoData: [], forcefield: {driving:[], restraining:[]}, swot: {s:[],w:[],o:[],t:[]}, fiveWhys: ["","","","",""]
            };
            showApp();
            renderAll();
            document.getElementById('demo-banner').classList.remove('hidden');
            showToast("Demo Loaded - Explore the populated tabs!");
        }

        document.getElementById('auth-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;
                if (authMode === 'signup') await createUserWithEmailAndPassword(auth, email, password);
                else await signInWithEmailAndPassword(auth, email, password);
            } catch (err) { alert(err.message); }
        });
        
        document.getElementById('logout-btn').addEventListener('click', () => { 
            isDemo = false; 
            signOut(auth); 
            location.reload(); 
        });
        
        document.getElementById('toggle-auth').onclick = (e) => { e.preventDefault(); authMode = authMode==='signin'?'signup':'signin'; document.getElementById('auth-btn-text').textContent = authMode==='signin'?'Sign In':'Sign Up'; document.getElementById('auth-title').textContent = authMode==='signin'?'Sign In':'Create Account'; };

        // --- DB ---
        function initRealtimeListener() {
            if (!currentUser || isDemo) return;
            onSnapshot(doc(db, 'projects', currentUser.uid), (doc) => {
                if (doc.exists()) {
                    projectData = { ...projectData, ...doc.data() };
                    // Structure Check
                    if(!projectData.fishbone || !projectData.fishbone.categories) projectData.fishbone = { categories: [{id:1, text:"People", causes:[]}, {id:2, text:"Methods", causes:[]}, {id:3, text:"Equipment", causes:[]}, {id:4, text:"Environment", causes:[]}] };
                    if(!projectData.drivers) projectData.drivers = { primary: [], secondary: [], changes: [] };
                    if(!projectData.fiveWhys) projectData.fiveWhys = ["","","","",""];
                    if(!projectData.forcefield) projectData.forcefield = { driving: [], restraining: [] };
                    document.getElementById('chart-goal').value = projectData.chartGoal || '';
                }
                renderAll();
                suggestNextStep();
            });
        }
        async function saveData() { 
            if(isDemo) return; 
            if(currentUser) await setDoc(doc(db, 'projects', currentUser.uid), projectData, { merge: true }); 
            const s = document.getElementById('save-status');
            s.innerHTML = '<i data-lucide="save" class="w-3 h-3 text-emerald-600"></i> Saved';
            s.classList.add('animate-pulse-fast');
            setTimeout(() => s.classList.remove('animate-pulse-fast'), 1000);
            lucide.createIcons(); 
        }
        window.saveData = saveData;

        // --- ROUTER & SHORTCUTS ---
        window.router = (viewId) => {
            if(viewId === 'poster') { updatePoster(); document.getElementById('view-poster').classList.remove('hidden'); return; }
            document.getElementById('view-poster').classList.add('hidden');
            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
            document.getElementById(`view-${viewId}`).classList.remove('hidden');
            if(viewId === 'tools') renderTools();
            if(viewId === 'data') renderChart();
        };
        window.toggleDarkMode = () => document.documentElement.classList.toggle('dark');
        window.openGuide = () => document.getElementById('guide-modal').classList.remove('hidden');
        window.openBulkImport = () => document.getElementById('bulk-modal').classList.remove('hidden');
        document.getElementById('mobile-menu-btn').onclick = () => { const sb = document.getElementById('app-sidebar'); sb.classList.toggle('hidden'); sb.classList.toggle('absolute'); sb.classList.toggle('z-40'); sb.classList.toggle('w-full'); };

        // Global Shortcuts
        document.addEventListener('keydown', (e) => {
            if ((e.ctrlKey || e.metaKey) && e.key === 's') { e.preventDefault(); saveData(); showToast("Saved"); }
            if (e.key === 'Escape') {
                document.querySelectorAll('.fixed').forEach(el => {
                    if(el.id !== 'auth-screen' && !el.classList.contains('hidden')) el.classList.add('hidden');
                });
            }
        });

        function renderAll() {
            renderDashboard(); renderChecklist(); renderChart(); renderTools(); renderGantt(); renderPDSA();
            lucide.createIcons();
        }

        // --- INTELLIGENT GUIDANCE ---
        function suggestNextStep() {
            const card = document.getElementById('next-step-card');
            const text = document.getElementById('next-step-text');
            const btn = document.getElementById('next-step-btn');
            
            if(!projectData.checklist.title) {
                text.textContent = "Start by defining your project title and problem.";
                btn.onclick = () => router('checklist');
                btn.textContent = "Go to Checklist";
                card.classList.remove('hidden');
            } else if (!projectData.checklist.aim) {
                text.textContent = "You need a SMART Aim. Use the Wizard to create one.";
                btn.onclick = openSmartWizard;
                btn.textContent = "Open Wizard";
                card.classList.remove('hidden');
            } else if (!projectData.drivers?.primary?.length) {
                text.textContent = "Plan your strategy. create a Driver Diagram.";
                btn.onclick = () => router('tools');
                btn.textContent = "Go to Tools";
                card.classList.remove('hidden');
            } else if (projectData.chartData.length === 0) {
                text.textContent = "Add your baseline data to the Run Chart.";
                btn.onclick = () => router('data');
                btn.textContent = "Add Data";
                card.classList.remove('hidden');
            } else {
                card.classList.add('hidden');
            }
        }

        window.startTour = () => {
            if(tour) tour.cancel();
            tour = new Shepherd.Tour({ useModalOverlay: true, defaultStepOptions: { classes: 'shadow-md bg-purple-dark', scrollTo: true } });
            tour.addStep({ title: 'Welcome', text: 'This is your Dashboard. It gives you a live overview of your project progress.', attachTo: { element: '#nav-dashboard', on: 'right' }, buttons: [{ text: 'Next', action: tour.next }] });
            tour.addStep({ title: 'Checklist', text: 'Start here. The QIAT Checklist aligns with the RCEM curriculum.', attachTo: { element: '#nav-checklist', on: 'right' }, buttons: [{ text: 'Next', action: tour.next }] });
            tour.addStep({ title: 'Visual Tools', text: 'Use "Change Tools" to build Fishbones and Driver Diagrams.', attachTo: { element: '#nav-tools', on: 'right' }, buttons: [{ text: 'Next', action: tour.next }] });
            tour.addStep({ title: 'Show Evidence', text: 'The "Data" tab creates SPC charts automatically. Just add your dates and numbers.', attachTo: { element: '#nav-data', on: 'right' }, buttons: [{ text: 'Finish', action: tour.next }] });
            tour.start();
        }

        // --- CHARTING ENGINE ---
        window.setChartMode = (m) => { chartMode = m; 
            document.getElementById('input-run').classList.toggle('hidden', m!=='run');
            document.getElementById('input-pareto').classList.toggle('hidden', m!=='pareto');
            document.getElementById('chart-input-title').textContent = m==='run' ? 'Add Data / Intervention' : 'Add Pareto Category';
            renderChart();
        }
        
        window.updateGoal = () => { projectData.chartGoal = document.getElementById('chart-goal').value; saveData(); renderChart(); }
        window.validateDate = (input) => {
            const d = new Date(input.value); const now = new Date();
            if(d > now) alert("Note: You entered a future date. Ensure this is intentional planning.");
        }

        function renderChart() {
            const ctx = document.getElementById('mainChart').getContext('2d');
            if (chartInstance) chartInstance.destroy();
            const isDark = document.documentElement.classList.contains('dark');
            const gridColor = isDark ? '#334155' : '#e2e8f0';

            if (chartMode === 'run') {
                const data = projectData.chartData || [];
                data.sort((a,b) => new Date(a.date) - new Date(b.date));
                const dataPoints = data.filter(d => d.type !== 'intervention');
                
                const values = dataPoints.map(d => parseFloat(d.value));
                const sorted = [...values].sort((a,b)=>a-b);
                const mid = Math.floor(sorted.length/2);
                const median = sorted.length%2!==0 ? sorted[mid] : (sorted[mid-1]+sorted[mid])/2;
                
                const pointColors = values.map((v, i) => {
                    if (i < 5) return '#2d2e83'; 
                    const subset = values.slice(i-5, i+1);
                    const allAbove = subset.every(x => x > median);
                    const allBelow = subset.every(x => x < median);
                    return (allAbove || allBelow) ? '#ef4444' : '#2d2e83'; 
                });

                const annotations = {};
                data.filter(d => d.type === 'intervention').forEach((d, i) => {
                    annotations[`line${i}`] = { type: 'line', xMin: d.date, xMax: d.date, borderColor: '#f36f21', borderWidth: 2, borderDash: [6, 6], label: { display: true, content: d.note || 'PDSA', position: 'start', backgroundColor: '#f36f21', color: 'white' } };
                });
                if(projectData.chartGoal) annotations['goal'] = { type: 'box', yMin: projectData.chartGoal, yMax: Math.max(...values, parseFloat(projectData.chartGoal)) * 1.1, backgroundColor: 'rgba(16, 185, 129, 0.1)', borderWidth: 0 };

                chartInstance = new Chart(ctx, {
                    type: 'line',
                    data: { labels: dataPoints.map(d => d.date), datasets: [{ label: 'Measure', data: values, borderColor: '#2d2e83', pointBackgroundColor: pointColors, pointRadius: 5, tension: 0.1 }, { label: 'Median', data: Array(values.length).fill(median), borderColor: '#94a3b8', borderDash: [5,5], pointRadius:0 }] },
                    options: { responsive: true, plugins: { annotation: { annotations } }, scales: { y: { beginAtZero: true, grid:{color:gridColor} }, x: { grid:{color:gridColor} } } }
                });
                document.getElementById('data-history-list').innerHTML = data.map((d,i)=>`<div class="flex justify-between text-sm border-b border-slate-200 dark:border-slate-700 p-2"><span><span class="font-bold ${d.type==='intervention'?'text-orange-500':'text-indigo-600'}">${d.type==='intervention'?'INT':'DAT'}</span> ${d.date}: ${d.type==='intervention' ? d.note : d.value}</span><button onclick="projectData.chartData.splice(${i},1);saveData()" class="text-red-500 hover:text-red-700">x</button></div>`).join('');
            
            } else {
                const data = projectData.paretoData || [];
                data.sort((a,b) => b.count - a.count);
                const total = data.reduce((a,b) => a + Number(b.count), 0);
                let acc = 0;
                const percentages = data.map(d => { acc += Number(d.count); return Math.round((acc/total)*100); });

                chartInstance = new Chart(ctx, {
                    type: 'bar',
                    data: { labels: data.map(d => d.cat), datasets: [{ type: 'line', label: 'Cumulative %', data: percentages, borderColor: '#f36f21', yAxisID: 'y1' }, { type: 'bar', label: 'Frequency', data: data.map(d => d.count), backgroundColor: '#2d2e83', yAxisID: 'y' }] },
                    options: { responsive: true, scales: { y: { beginAtZero: true, position: 'left' }, y1: { beginAtZero: true, position: 'right', max: 100 } } }
                });
                document.getElementById('data-history-list').innerHTML = data.map((d,i)=>`<div class="flex justify-between text-sm border-b p-2"><span>${d.cat}: <b>${d.count}</b></span><button onclick="projectData.paretoData.splice(${i},1);saveData()" class="text-red-500">x</button></div>`).join('');
            }
        }
        window.addDataPoint = () => { 
            const date = document.getElementById('chart-date').value; const type = document.getElementById('chart-type').value; const value = document.getElementById('chart-value').value; const note = document.getElementById('chart-note').value;
            if(date && (value || type === 'intervention')) { projectData.chartData.push({ date, value, type, note }); saveData(); }
        }
        window.addParetoData = () => { projectData.paretoData.push({ cat: document.getElementById('pareto-cat').value, count: document.getElementById('pareto-count').value }); saveData(); }
        window.handleBulkImport = () => {
            const raw = document.getElementById('bulk-text').value;
            const lines = raw.split('\n');
            let added = 0;
            lines.forEach(l => {
                const [d, v] = l.split(/\t|,/); // Split by tab or comma
                if(d && v && !isNaN(parseFloat(v))) {
                    projectData.chartData.push({ date: d.trim(), value: v.trim(), type: 'data' });
                    added++;
                }
            });
            saveData();
            document.getElementById('bulk-modal').classList.add('hidden');
            showToast(`Imported ${added} points`);
        }

        // --- MERMAID ---
        window.setToolMode = (m) => { toolMode = m; renderTools(); }
        async function renderTools() {
            const container = document.getElementById('tool-canvas'); const controls = document.getElementById('tool-controls'); let mermaidCode = '';
            if (toolMode === 'fishbone') {
                const cats = projectData.fishbone.categories;
                mermaidCode = `mindmap\n  root((PROBLEM))\n`; cats.forEach(c => { mermaidCode += `    ${c.text}\n`; c.causes.forEach(cause => mermaidCode += `      ${cause}\n`); });
                controls.innerHTML = cats.map(c => `<button onclick="addFish(${c.id})" class="bg-indigo-100 text-indigo-800 px-2 py-1 rounded text-xs">+ ${c.text}</button>`).join('');
            } else if (toolMode === 'driver') {
                const d = projectData.drivers;
                mermaidCode = `graph LR\n  AIM[AIM] --> P[Primary Drivers]\n  P --> S[Secondary Drivers]\n  S --> C[Change Ideas]\n`;
                d.primary.forEach((p,i) => mermaidCode += `  P --> P${i}[${p}]\n`); d.secondary.forEach((s,i) => mermaidCode += `  S --> S${i}[${s}]\n`); d.changes.forEach((c,i) => mermaidCode += `  C --> C${i}[${c}]\n`);
                controls.innerHTML = `<button onclick="addDriver('primary')" class="bg-emerald-100 text-emerald-800 px-2 py-1 rounded text-xs">+ Primary</button><button onclick="addDriver('secondary')" class="bg-blue-100 text-blue-800 px-2 py-1 rounded text-xs">+ Secondary</button><button onclick="addDriver('changes')" class="bg-purple-100 text-purple-800 px-2 py-1 rounded text-xs">+ Change Idea</button><button onclick="clearDrivers()" class="text-red-500 text-xs ml-2">Clear</button>`;
            } else { container.innerHTML = `<div class="text-slate-400">Select Fishbone or Driver for Vector Diagrams.</div>`; controls.innerHTML = ''; return; }
            container.innerHTML = `<div class="mermaid">${mermaidCode}</div>`; try { await mermaid.run(); } catch(e) { console.log(e); }
        }
        window.addFish = (id) => { const t=prompt("Cause:"); if(t){projectData.fishbone.categories.find(c=>c.id===id).causes.push(t); saveData(); renderTools();} }
        window.addDriver = (k) => { const t=prompt("Item:"); if(t){projectData.drivers[k].push(t); saveData(); renderTools();} }
        window.clearDrivers = () => { if(confirm("Clear?")){ projectData.drivers={primary:[],secondary:[],changes:[]}; saveData(); renderTools(); } }
        window.downloadDiagram = async () => {
            const svg = document.querySelector('#tool-canvas svg'); if(!svg) return;
            const svgData = new XMLSerializer().serializeToString(svg); const canvas = document.createElement("canvas"); const ctx = canvas.getContext("2d"); const img = new Image();
            img.onload = () => { canvas.width = img.width; canvas.height = img.height; ctx.drawImage(img, 0, 0); const a = document.createElement('a'); a.download = "diagram.png"; a.href = canvas.toDataURL("image/png"); a.click(); };
            img.src = "data:image/svg+xml;base64," + btoa(unescape(encodeURIComponent(svgData)));
        }

        // --- DASHBOARD & CHECKLIST ---
        function renderDashboard() {
            const filled = Object.values(projectData.checklist || {}).filter(v => v).length;
            const progress = Math.min(100, Math.round((filled / 10) * 100));
            document.getElementById('stats-grid').innerHTML = `<div class="glass p-6 rounded-xl"><div class="flex justify-between"><span class="text-slate-500">Checklist</span><i data-lucide="check-square" class="text-emerald-500 w-6 h-6"></i></div><div class="text-3xl font-bold dark:text-white">${progress}%</div></div><div class="glass p-6 rounded-xl"><div class="flex justify-between"><span class="text-slate-500">Cycles</span><i data-lucide="refresh-cw" class="text-blue-500 w-6 h-6"></i></div><div class="text-3xl font-bold dark:text-white">${projectData.pdsa.length}</div></div><div class="glass p-6 rounded-xl"><div class="flex justify-between"><span class="text-slate-500">Data</span><i data-lucide="bar-chart-2" class="text-amber-500 w-6 h-6"></i></div><div class="text-3xl font-bold dark:text-white">${projectData.chartData.length}</div></div>`;
            document.getElementById('dashboard-aim').textContent = projectData.checklist?.aim || "No aim defined.";
            
            // Empty State Logic
            if(projectData.chartData.length === 0 && projectData.pdsa.length === 0 && !projectData.checklist.title) {
                document.getElementById('get-started-card').classList.remove('hidden');
            } else {
                document.getElementById('get-started-card').classList.add('hidden');
            }
        }
        window.openSmartWizard = () => document.getElementById('smart-modal').classList.remove('hidden');
        window.saveSmartAim = () => {
            const s = document.getElementById('smart-s').value; const m = document.getElementById('smart-m').value; const p = document.getElementById('smart-p').value; const t = document.getElementById('smart-t').value;
            projectData.checklist.aim = `To ${s || 'improve x'} for ${p || 'patients'} by ${m || 'a measurable amount'} by ${t || 'date'}.`; saveData(); document.getElementById('smart-modal').classList.add('hidden');
        }
        
        window.emailSupervisor = () => {
            const subject = encodeURIComponent(`QIP Review: ${projectData.checklist.title || 'Untitled'}`);
            const body = encodeURIComponent(`Dear Supervisor,\n\nPlease review my QIP.\n\nAIM: ${projectData.checklist.aim || 'Not set'}\n\nSUMMARY: ${projectData.checklist.results_summary || 'Not set'}`);
            window.location.href = `mailto:?subject=${subject}&body=${body}`;
        }

        window.copyText = (text) => {
            navigator.clipboard.writeText(text).then(() => showToast("Copied to Clipboard"));
        }

        window.updatePoster = () => {
            document.getElementById('poster-title').textContent = projectData.checklist.title || 'Untitled QIP'; document.getElementById('poster-team').textContent = projectData.checklist.team || 'Team'; document.getElementById('poster-problem').textContent = projectData.checklist.problem_desc || 'No problem defined.'; document.getElementById('poster-aim').textContent = projectData.checklist.aim || 'No aim defined.'; document.getElementById('poster-results').textContent = projectData.checklist.results_summary || 'No results yet.'; document.getElementById('poster-learning').textContent = projectData.checklist.learning || 'No conclusion yet.'; document.getElementById('poster-pdsa').innerHTML = projectData.pdsa.slice(0,3).map(c => `<div><strong>${c.title}:</strong> ${c.act}</div>`).join('');
            const chartCanvas = document.getElementById('mainChart'); if(chartCanvas) document.getElementById('poster-chart').src = chartCanvas.toDataURL();
            const d = projectData.drivers; document.getElementById('poster-driver').innerHTML = `<ul class="list-disc pl-5 text-sm"><li>Primary: ${d.primary.join(', ')}</li><li>Secondary: ${d.secondary.join(', ')}</li><li>Changes: ${d.changes.join(', ')}</li></ul>`;
        }

        window.generateReport = () => {
            const el = document.getElementById('report-template'); el.classList.remove('hidden');
            document.getElementById('rep-title').textContent = projectData.checklist.title || 'Untitled'; document.getElementById('rep-lead').textContent = projectData.checklist.lead || ''; document.getElementById('rep-team').textContent = projectData.checklist.team || ''; document.getElementById('rep-problem').textContent = projectData.checklist.problem_desc || ''; document.getElementById('rep-aim').textContent = projectData.checklist.aim || ''; document.getElementById('rep-driver-list').textContent = `Primary: ${projectData.drivers.primary.join(', ')}. Interventions: ${projectData.drivers.changes.join(', ')}.`; document.getElementById('rep-pdsa-list').innerHTML = projectData.pdsa.map(c => `<div><strong>${c.title}:</strong> ${c.act}</div>`).join(''); document.getElementById('rep-results').textContent = projectData.checklist.results_summary || ''; document.getElementById('rep-learning').textContent = projectData.checklist.learning || '';
            const canvas = document.getElementById('mainChart'); if(canvas) document.getElementById('rep-chart-img').src = canvas.toDataURL();
            html2pdf().from(el).set({ margin: 0.5, filename: 'RCEM_QIP_Report.pdf' }).save().then(() => el.classList.add('hidden'));
        }

        // --- RENDERERS ---
        function renderChecklist() {
            const checklistConfig = [
             { title: "1. Problem & Evidence", icon: "alert-circle", fields: ["title", "lead", "team", "problem_desc", "evidence"], placeholders: ["Sepsis 6 Compliance", "Dr. Name", "Nurses, Consultants", "Only 40% of patients get Abx in 1h", "Local audit 2024 data"] },
             { title: "2. Aim & Measures", icon: "target", fields: ["aim", "outcome_measures", "process_measures", "balance_measures"], placeholders: ["To improve X by Y date", "Time to Antibiotics (mins)", "Screening Tool Usage %", "Delays in other areas"] },
             { title: "3. Strategy", icon: "git-branch", fields: ["strategy_summary"], desc:"Summarize driver diagram here", placeholders: ["Focus on education and grab bags"] },
             { title: "4. Results & Reflection", icon: "file-text", fields: ["results_summary", "learning", "sustainability"], placeholders: ["Compliance rose to 85%", "Staff engagement was key", "Added to induction pack"] }
            ];
            document.getElementById('checklist-container').innerHTML = checklistConfig.map((sec, i) => `
                <details class="glass rounded-xl shadow-sm overflow-hidden group" ${i===0?'open':''}>
                    <summary class="px-6 py-4 flex items-center gap-3 cursor-pointer bg-slate-50/50 dark:bg-slate-800"><i data-lucide="${sec.icon}" class="text-rcem-purple dark:text-indigo-400 w-5 h-5"></i><h3 class="font-semibold text-slate-800 dark:text-white flex-1">${sec.title}</h3></summary>
                    <div class="p-6 space-y-4">${sec.fields.map((f, idx) => `<div><label class="flex justify-between text-sm font-medium dark:text-slate-300 capitalize mb-1"><span>${f.replace(/_/g,' ')}</span><button onclick="copyText(this.parentElement.nextElementSibling.value)" class="text-xs text-indigo-500 hover:text-indigo-700"><i data-lucide="copy" class="w-3 h-3 inline"></i> Copy</button></label><textarea onchange="projectData.checklist['${f}']=this.value;saveData()" class="w-full rounded border-slate-300 dark:border-slate-600 dark:bg-slate-900 p-2 text-sm" placeholder="e.g. ${sec.placeholders?.[idx] || 'Enter details...'}">${projectData.checklist[f]||''}</textarea></div>`).join('')}</div>
                </details>`).join('');
        }
        
        function renderGantt() {
            const container = document.getElementById('gantt-chart-area'); const tasks = projectData.gantt || [];
            if(tasks.length === 0) { container.innerHTML = `<div class="text-center text-slate-400 mt-10">No tasks added yet.</div>`; return; }
            const dates = tasks.flatMap(t => [new Date(t.start), new Date(t.end)]); const min = new Date(Math.min(...dates)); const max = new Date(Math.max(...dates)); const totalTime = Math.max(1, max - min) + (1000*60*60*24*10); 
            document.getElementById('gantt-range').textContent = `Timeline (${min.toLocaleDateString()} - ${max.toLocaleDateString()})`;
            container.innerHTML = tasks.map(t => { const start = new Date(t.start); const end = new Date(t.end); const left = ((start - min) / totalTime) * 100; const width = Math.max(2, ((end - start) / totalTime) * 100); return `<div class="relative mb-4 flex items-center z-10"><div class="w-1/4 pr-4 flex items-center justify-between"><span class="text-sm font-medium text-slate-700 dark:text-slate-300 truncate">${escapeHtml(t.name)}</span><button onclick="removeGanttTask('${t.id}')" class="text-slate-300 hover:text-red-500"><i data-lucide="trash-2" class="w-4 h-4"></i></button></div><div class="flex-1 relative h-8 bg-slate-100 dark:bg-slate-700 rounded-full overflow-hidden"><div class="absolute top-0 h-full rounded-full shadow-sm flex items-center px-2 text-xs text-white bg-rcem-purple" style="left: ${left}%; width: ${width}%">${t.status}</div></div></div>`; }).join('');
        }
        window.addGanttTask = () => { projectData.gantt.push({ id:Date.now(), name:document.getElementById('gantt-name').value, start:document.getElementById('gantt-start').value, end:document.getElementById('gantt-end').value, status:document.getElementById('gantt-status').value }); saveData(); }
        window.removeGanttTask = (id) => { projectData.gantt = projectData.gantt.filter(t => t.id !== id); saveData(); };

        function renderPDSA() {
            document.getElementById('pdsa-list').innerHTML = projectData.pdsa.map(c => `
                <div class="glass rounded-xl shadow-sm overflow-hidden mb-4">
                    <div class="px-6 py-4 bg-slate-50/50 dark:bg-slate-700 border-b dark:border-slate-600 flex justify-between">
                        <h4 class="font-bold dark:text-white text-rcem-purple">${c.title} (${c.date})</h4>
                        <div class="flex gap-2"><button onclick="copyText('${c.plan} ${c.do} ${c.study} ${c.act}')" class="text-indigo-500 text-xs">Copy All</button><button onclick="deletePDSA('${c.id}')" class="text-red-500 hover:text-red-700 text-xs">Delete</button></div>
                    </div>
                    <div class="p-4 grid grid-cols-2 gap-4">
                        ${['Plan','Do','Study','Act'].map(s=>`<div><label class="text-xs font-bold dark:text-slate-300 uppercase">${s}</label><textarea onchange="updatePDSA('${c.id}','${s.toLowerCase()}',this.value)" class="w-full text-sm p-2 border rounded dark:bg-slate-900 dark:border-slate-600 h-20" placeholder="Enter details...">${c[s.toLowerCase()]||''}</textarea></div>`).join('')}
                    </div>
                </div>`).join('');
        }
        window.addPDSACycle = () => { 
            const d = new Date().toLocaleDateString();
            projectData.pdsa.unshift({ id: Date.now().toString(), title: `Cycle ${projectData.pdsa.length+1}`, date: d }); 
            saveData(); 
        }
        window.updatePDSA = (id,f,v) => { projectData.pdsa.find(c=>c.id===id)[f]=v; saveData(); }
        window.deletePDSA = (id) => { if(confirm('Delete?')) { projectData.pdsa=projectData.pdsa.filter(c=>c.id!==id); saveData(); } }
        
        // Green ED
        window.calcCarbon = () => { document.getElementById('green-result').textContent = `Total: ${(document.getElementById('green-item').value * document.getElementById('green-qty').value).toFixed(2)} kg CO2e`; document.getElementById('green-result').classList.remove('hidden'); }
        
        window.resetProject = async () => { if(confirm("Delete all data?")) { projectData={checklist:{},fishbone:{categories:[]},drivers:{primary:[],secondary:[],changes:[]},forcefield:{driving:[],restraining:[]},swot:{s:[],w:[],o:[],t:[]},fiveWhys:["","","","",""],gantt:[],pdsa:[],chartData:[],paretoData:[],chartGoal:null}; await saveData(); location.reload(); } }
        window.downloadJSON = () => { const a = document.createElement('a'); a.href = "data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(projectData)); a.download = "qip_backup.json"; a.click(); }
        window.restoreJSON = (i) => { const r = new FileReader(); r.onload = (e) => { projectData = JSON.parse(e.target.result); saveData(); location.reload(); }; r.readAsText(i.files[0]); }

        lucide.createIcons();
        router('dashboard');
    </script>
</body>
</html>
